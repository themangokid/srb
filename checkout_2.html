<!DOCTYPE html>
<html lang="sv">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=3.0, user-scalable=yes">

    <!-- Icons-->
    <link rel="icon" type="image/png" href="favicon/favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/svg+xml" href="favicon/favicon.svg" />
    <link rel="shortcut icon" href="favicon/favicon.ico" />
    <link rel="apple-touch-icon" sizes="180x180" href="favicon/apple-touch-icon.png" />

    <!-- Fonts and styles-->
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="checkout.css">
    <title>Svenska Reformationsbibeln - Beställning</title>
    <link href="https://fonts.googleapis.com/css2?family=EB+Garamond:wght@400;500;600;700&display=swap"
        rel="stylesheet">
    <!-- Add Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body>
    <!-- Header -->
    <header class="header">
        <nav class="nav-container">
            <div class="logo">
                <a href="index.html">
                    <div class="logo-icon"></div>
                </a>
            </div>
            <ul class="nav-menu">
                <li><a href="index.html">Hem</a></li>
                <li><a href="QnA.html">Frågor & svar</a></li>
                <li><a href="index.html#resurser">Resurser</a></li>
                <li><a href="https://bibel.se" target="_blank">Bibel.se</a></li>
                <li><a href="index.html#kontakt">Kontakt</a></li>
            </ul>
            <div class="hamburger">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </nav>
    </header>

    <div class="order-container">
        <h1 style="text-align: center; color: var(--primary-text); margin-bottom: 2rem; font-size: 2.5rem;">
            Beställ Svenska Reformationsbibeln
        </h1>

        <!-- Step Indicator -->
        <div class="step-indicator">
            <div class="step active" data-step="1">
                <div class="step-number">1</div>
                <span>Formulär</span>
            </div>
            <div class="step" data-step="2">
                <div class="step-number">2</div>
                <span>Swish (Betala)</span>
            </div>
            <div class="step" data-step="3">
                <div class="step-number">3</div>
                <span>Skicka info via e-post</span>
            </div>
        </div>

        <!-- Order Form -->
        <div class="order-form">
            <div class="error-message" id="errorMessage"></div>

            <!-- Step 1: Complete Order Form -->
            <div class="form-section active" data-section="1">
                <h2><i class="fas fa-shopping-cart"></i> Beställningsuppgifter</h2>
                
                <!-- Quantity Selection -->
                <div style="background: rgba(139, 105, 20, 0.05); border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem; border: 1px solid var(--border-color);">
                    <h3 style="color: var(--primary-text); margin-bottom: 1rem; font-size: 1.3rem;">
                        <i class="fas fa-book"></i> Välj antal
                    </h3>
                    
                    <div class="info-box">
                        <p><strong>Svenska Reformationsbibeln</strong> - En modern översättning av Karl XII:s Bibel från 1703, baserad på Textus Receptus. Pris: 200 kr per exemplar + frakt.</p>
                    </div>

                    <div class="quantity-selector">
                        <button type="button" class="quantity-btn" id="decreaseBtn">−</button>
                        <div class="quantity-display" id="quantityDisplay">1</div>
                        <button type="button" class="quantity-btn" id="increaseBtn">+</button>
                    </div>

                    <div class="price-summary">
                        <div class="price-line">
                            <span>Biblar (<span id="summaryQuantity">1</span> st):</span>
                            <span id="subtotal">200 kr</span>
                        </div>
                        <div class="price-line">
                            <span>Frakt:</span>
                            <span id="shipping">49 kr</span>
                        </div>
                        <div class="price-line total">
                            <span>Totalt:</span>
                            <span id="total">249 kr</span>
                        </div>
                    </div>
                </div>

                <!-- Contact Information -->
                <div style="background: rgba(139, 105, 20, 0.05); border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem; border: 1px solid var(--border-color);">
                    <h3 style="color: var(--primary-text); margin-bottom: 1rem; font-size: 1.3rem;">
                        <i class="fas fa-user"></i> Kontaktuppgifter
                    </h3>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group required">
                            <label for="firstName">Förnamn</label>
                            <input type="text" id="firstName" name="given-name" autocomplete="given-name" required>
                        </div>

                        <div class="form-group required">
                            <label for="lastName">Efternamn</label>
                            <input type="text" id="lastName" name="family-name" autocomplete="family-name" required>
                        </div>
                    </div>

                    <div class="form-group required">
                        <label for="email">E-postadress</label>
                        <input type="email" id="email" name="email" autocomplete="email" required>
                    </div>

                    <div class="form-group required">
                        <label for="phone">Telefonnummer (för Swish-betalning)</label>
                        <input type="tel" id="phone" name="tel" autocomplete="tel" placeholder="070-123 45 67" required>
                    </div>
                </div>

                <!-- Delivery Information -->
                <div style="background: rgba(139, 105, 20, 0.05); border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem; border: 1px solid var(--border-color);">
                    <h3 style="color: var(--primary-text); margin-bottom: 1rem; font-size: 1.3rem;">
                        <i class="fas fa-truck"></i> Leveransadress
                    </h3>

                    <div class="form-group required">
                        <label for="street">Gatuadress</label>
                        <input type="text" id="street" name="address-line1" autocomplete="address-line1" placeholder="Gatunamn och nummer" required>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 1rem;">
                        <div class="form-group required">
                            <label for="postalCode">Postnummer</label>
                            <input type="text" id="postalCode" name="postal-code" autocomplete="postal-code" placeholder="123 45" pattern="[0-9]{3}\s?[0-9]{2}" required>
                        </div>

                        <div class="form-group required">
                            <label for="city">Ort</label>
                            <input type="text" id="city" name="address-level2" autocomplete="address-level2" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="country">Land</label>
                        <select id="country" name="country" autocomplete="country">
                            <option value="Sverige" selected>Sverige</option>
                            <option value="Norge">Norge</option>
                            <option value="Danmark">Danmark</option>
                            <option value="Finland">Finland</option>
                            <option value="Island">Island</option>
                        </select>
                    </div>
                </div>

                <div class="btn-group">
                    <div></div>
                    <button type="button" class="btn btn-primary" id="nextStepBtn">
                        Granska beställning <i class="fas fa-check"></i>
                    </button>
                </div>
            </div>

            <!-- Step 2: Swish Payment -->
            <div class="form-section" data-section="2">
                <div style="text-align: center; padding: 2rem;">
                    <i class="fas fa-mobile-alt" style="font-size: 4rem; color: #2d5f3f; margin-bottom: 1.5rem;"></i>
                    <h2 style="font-size: 2rem; margin-bottom: 1rem;">Betala via Swish</h2>
                    <p style="font-size: 1.3rem; margin-bottom: 1.5rem;">Swish-appen öppnas automatiskt för betalning</p>
                    
                    <div style="background: rgba(46, 125, 50, 0.1); border: 2px solid #2d5f3f; border-radius: 12px; padding: 1.5rem; margin: 1.5rem auto; max-width: 500px;">
                        <p style="font-size: 1.1rem; margin: 0;"><strong>Ordernummer:</strong> <span id="orderNumberStep2"></span></p>
                        <p style="font-size: 1.1rem; margin: 0.5rem 0 0 0;"><strong>Belopp:</strong> <span id="totalAmountStep2"></span> kr</p>
                    </div>

                    <div class="btn-group" style="margin-top: 2rem;">
                        <button type="button" class="btn btn-secondary" id="prevStepBtn">
                            <i class="fas fa-arrow-left"></i> Tillbaka
                        </button>
                        <button type="button" class="btn btn-primary" id="proceedToEmailBtn">
                            Betalning klar - Nästa steg <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Step 3: Send Email -->
            <div class="form-section" data-section="3">
                <div style="text-align: center; padding: 2rem;">
                    <i class="fas fa-envelope" style="font-size: 4rem; color: #d4af37; margin-bottom: 1.5rem;"></i>
                    <h2 style="font-size: 2rem; margin-bottom: 1rem;">Skicka orderbekräftelse</h2>
                    <p style="font-size: 1.3rem; margin-bottom: 1.5rem;">För att slutföra beställningen, skicka orderinformationen via e-post</p>
                    
                    <div style="background: rgba(139, 105, 20, 0.1); border: 2px solid var(--accent-color); border-radius: 12px; padding: 1.5rem; margin: 1.5rem auto; max-width: 500px;">
                        <p style="font-size: 1.1rem; margin: 0;"><strong>Ordernummer:</strong> <span id="orderNumberStep3"></span></p>
                        <p style="font-size: 1rem; margin: 0.5rem 0 0 0;">E-posten innehåller all orderinformation och skickas till postATbibel.se</p>
                    </div>

                    <div style="margin: 2rem 0;">
                        <button id="sendEmailBtn" class="btn btn-primary" style="font-size: 1.2rem; padding: 1.2rem 2rem;">
                            <i class="fas fa-envelope" style="font-size: 1.1rem; margin-right: 0.5rem;"></i> Skicka orderbekräftelse
                        </button>
                    </div>

                    <div style="background: rgba(46, 125, 50, 0.1); border-left: 4px solid #2d5f3f; padding: 1rem; margin: 1.5rem auto; border-radius: 0 8px 8px 0; max-width: 500px; text-align: left;">
                        <h4 style="margin-bottom: 0.5rem; font-size: 1.1rem;"><i class="fas fa-check-circle" style="color: #2d5f3f; margin-right: 0.5rem;"></i>Efter e-post skickad:</h4>
                        <p style="margin: 0; font-size: 1rem;">Din beställning behandlas och skickas inom 3-5 arbetsdagar. Du får en bekräftelse när ordern är på väg.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer id="kontakt" class="footer">
        <div class="footer-content">
            <h3>© 2025 Svenska Reformationsbibelsällskapet</h3>
            <p>En modern version av Karl XII:s Bibel från 1703, baserad på Textus Receptus</p>
            <p>Bankgiro: 5808-7446 | Swish: 1233882669 | E-post: post@bibel.se</p>
        </div>
    </footer>

    <script>
        // Order state management with session persistence
        let orderState = {
            quantity: 1,
            currentStep: 1,
            formData: {},
            orderNumber: null,
            totalAmount: null,
            sessionId: null
        };

        // Pricing configuration
        const BIBLE_PRICE = 200;
        const SHIPPING_COST = 49;

        // Global variable to store email data
        let storedEmailData = null;

        // DOM elements - will be initialized after DOM loads
        let quantityDisplay, summaryQuantity, subtotal, shipping, total, errorMessage;

        // Generate truly unique order number with better entropy
        function generateUniqueOrderNumber() {
            const now = new Date();
            const year = now.getFullYear().toString().slice(-2);
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hour = String(now.getHours()).padStart(2, '0');
            const minute = String(now.getMinutes()).padStart(2, '0');
            
            // Generate random string
            const randomChars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let randomString = '';
            for (let i = 0; i < 6; i++) {
                randomString += randomChars.charAt(Math.floor(Math.random() * randomChars.length));
            }
            
            // Combine timestamp and random for uniqueness
            const timestamp = Date.now().toString(36).toUpperCase();
            
            return `SRB-${year}${month}${day}-${hour}${minute}-${randomString}-${timestamp}`;
        }

        // Session management
        function createOrResumeSession() {
            // Check if there's an existing session in URL or localStorage
            const urlParams = new URLSearchParams(window.location.search);
            const urlOrderNumber = urlParams.get('order');
            
            // Try to get existing session
            let existingSession = null;
            if (urlOrderNumber) {
                existingSession = loadSessionByOrderNumber(urlOrderNumber);
            } else {
                existingSession = loadLastSession();
            }
            
            if (existingSession) {
                // Resume existing session
                console.log('Resuming existing session:', existingSession.orderNumber);
                orderState = { ...orderState, ...existingSession };
                restoreFormFromSession();
                updateAllDisplays();
                return true;
            } else {
                // Create new session
                const newOrderNumber = generateUniqueOrderNumber();
                orderState.orderNumber = newOrderNumber;
                orderState.sessionId = newOrderNumber; // Use order number as session ID
                console.log('Created new session:', newOrderNumber);
                saveSession();
                return false;
            }
        }

        function saveSession() {
            const sessionData = {
                ...orderState,
                timestamp: new Date().toISOString(),
                lastActivity: Date.now()
            };
            
            try {
                localStorage.setItem(`order_${orderState.orderNumber}`, JSON.stringify(sessionData));
                localStorage.setItem('lastOrderNumber', orderState.orderNumber);
                console.log('Session saved:', orderState.orderNumber);
                
                // Update URL without page reload
                const url = new URL(window.location);
                url.searchParams.set('order', orderState.orderNumber);
                window.history.replaceState({}, '', url);
            } catch (e) {
                console.error('Failed to save session:', e);
            }
        }

        function loadSessionByOrderNumber(orderNumber) {
            try {
                const sessionData = localStorage.getItem(`order_${orderNumber}`);
                if (sessionData) {
                    return JSON.parse(sessionData);
                }
            } catch (e) {
                console.error('Failed to load session:', e);
            }
            return null;
        }

        function loadLastSession() {
            try {
                const lastOrderNumber = localStorage.getItem('lastOrderNumber');
                if (lastOrderNumber) {
                    return loadSessionByOrderNumber(lastOrderNumber);
                }
            } catch (e) {
                console.error('Failed to load last session:', e);
            }
            return null;
        }

        function restoreFormFromSession() {
            if (orderState.formData && Object.keys(orderState.formData).length > 0) {
                // Restore form fields
                const fields = [
                    'firstName', 'lastName', 'email', 'phone',
                    'street', 'postalCode', 'city', 'country'
                ];
                
                fields.forEach(field => {
                    const element = document.getElementById(field);
                    if (element && orderState.formData[field]) {
                        element.value = orderState.formData[field];
                    }
                });
                
                // Restore quantity
                if (orderState.quantity) {
                    updateQuantityDisplay();
                    updatePricing();
                }
                
                console.log('Form restored from session');
            }
        }

        function updateAllDisplays() {
            // Update step indicator
            updateStepIndicator();
            
            // Show current step
            showFormSection(orderState.currentStep);
            
            // Update order number displays
            const orderNumberElements = [
                'orderNumberStep2',
                'orderNumberStep3'
            ];
            
            orderNumberElements.forEach(id => {
                const element = document.getElementById(id);
                if (element && orderState.orderNumber) {
                    element.textContent = orderState.orderNumber;
                }
            });
            
            // Update total amount displays
            if (orderState.totalAmount) {
                const totalElement = document.getElementById('totalAmountStep2');
                if (totalElement) {
                    totalElement.textContent = orderState.totalAmount;
                }
            }
        }

        // Initialize DOM elements and set up event listeners
        function initializeApp() {
            console.log('Initializing app...');
            
            // Create or resume session first
            const isResumedSession = createOrResumeSession();
            
            // Get DOM elements
            quantityDisplay = document.getElementById('quantityDisplay');
            summaryQuantity = document.getElementById('summaryQuantity');
            subtotal = document.getElementById('subtotal');
            shipping = document.getElementById('shipping');
            total = document.getElementById('total');
            errorMessage = document.getElementById('errorMessage');

            // Verify critical elements exist
            if (!quantityDisplay || !summaryQuantity || !subtotal || !shipping || !total) {
                console.error('Critical DOM elements not found');
                return;
            }

            // Add event listeners for buttons - with null checks
            const decreaseBtn = document.getElementById('decreaseBtn');
            const increaseBtn = document.getElementById('increaseBtn');
            const nextStepBtn = document.getElementById('nextStepBtn');
            const prevStepBtn = document.getElementById('prevStepBtn');
            const proceedToEmailBtn = document.getElementById('proceedToEmailBtn');
            const sendEmailBtn = document.getElementById('sendEmailBtn');

            if (decreaseBtn) {
                decreaseBtn.addEventListener('click', () => {
                    console.log('Decrease button clicked');
                    changeQuantity(-1);
                });
            }

            if (increaseBtn) {
                increaseBtn.addEventListener('click', () => {
                    console.log('Increase button clicked');
                    changeQuantity(1);
                });
            }

            if (nextStepBtn) {
                nextStepBtn.addEventListener('click', () => {
                    console.log('Next step button clicked');
                    nextStep();
                });
            }

            if (prevStepBtn) {
                prevStepBtn.addEventListener('click', () => {
                    console.log('Previous step button clicked');
                    prevStep();
                });
            }

            if (proceedToEmailBtn) {
                proceedToEmailBtn.addEventListener('click', () => {
                    console.log('Proceed to email button clicked');
                    nextStep();
                });
            }

            if (sendEmailBtn) {
                sendEmailBtn.addEventListener('click', () => {
                    console.log('Send email button clicked');
                    sendOrderEmail();
                });
            } else {
                console.log('Send email button not found (this is normal until step 3)');
            }

            // Mobile menu functionality
            const hamburger = document.querySelector('.hamburger');
            const navMenu = document.querySelector('.nav-menu');

            if (hamburger && navMenu) {
                hamburger.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    navMenu.classList.toggle('active');
                    hamburger.classList.toggle('active');
                });

                document.querySelectorAll('.nav-menu a').forEach(link => {
                    link.addEventListener('click', () => {
                        navMenu.classList.remove('active');
                        hamburger.classList.remove('active');
                    });
                });

                document.addEventListener('click', (e) => {
                    if (!hamburger.contains(e.target) && !navMenu.contains(e.target)) {
                        navMenu.classList.remove('active');
                        hamburger.classList.remove('active');
                    }
                });
            }

            // Initialize display
            updateQuantityDisplay();
            updatePricing();
            updateStepIndicator();
            
            console.log('App initialized successfully');
        }

        // Quantity management
        function changeQuantity(delta) {
            const newQuantity = Math.max(1, orderState.quantity + delta);
            orderState.quantity = newQuantity;
            updateQuantityDisplay();
            updatePricing();
        }

        function updateQuantityDisplay() {
            if (quantityDisplay && summaryQuantity) {
                quantityDisplay.textContent = orderState.quantity;
                summaryQuantity.textContent = orderState.quantity;
            }
        }

        function updatePricing() {
            const subtotalAmount = orderState.quantity * BIBLE_PRICE;
            const totalAmount = subtotalAmount + SHIPPING_COST;

            if (subtotal && shipping && total) {
                subtotal.textContent = `${subtotalAmount} kr`;
                shipping.textContent = `${SHIPPING_COST} kr`;
                total.textContent = `${totalAmount} kr`;
            }
        }

        // Step management
        function updateStepIndicator() {
            const steps = document.querySelectorAll('.step');
            steps.forEach((step, index) => {
                const stepNumber = index + 1;
                step.classList.remove('active', 'completed');
                
                if (stepNumber < orderState.currentStep) {
                    step.classList.add('completed');
                    step.querySelector('.step-number').innerHTML = '<i class="fas fa-check"></i>';
                } else if (stepNumber === orderState.currentStep) {
                    step.classList.add('active');
                    step.querySelector('.step-number').textContent = stepNumber;
                } else {
                    step.querySelector('.step-number').textContent = stepNumber;
                }
            });
        }

        function showFormSection(stepNumber) {
            // Hide all sections
            const sections = document.querySelectorAll('.form-section');
            sections.forEach(section => {
                section.classList.remove('active');
                section.style.display = 'none';
            });
            
            // Show target section
            const targetSection = document.querySelector(`[data-section="${stepNumber}"]`);
            if (targetSection) {
                targetSection.style.display = 'block';
                // Use setTimeout to ensure display is set before adding class for animation
                setTimeout(() => {
                    targetSection.classList.add('active');
                    
                    // If showing step 2, ensure order summary is generated
                    if (stepNumber === 2) {
                        setTimeout(() => {
                            console.log('Re-generating order summary after section display');
                            generateOrderSummary();
                        }, 100);
                    }
                }, 10);
            }
        }

        function nextStep() {
            console.log('Next step called, current step:', orderState.currentStep);
            
            if (!validateCurrentStep()) {
                console.log('Validation failed');
                return;
            }
            
            hideError();
            saveCurrentStepData();
            
            orderState.currentStep++;
            console.log('Moving to step:', orderState.currentStep);
            
            // Handle step-specific actions
            if (orderState.currentStep === 2) {
                // Use existing order number or generate if somehow missing
                if (!orderState.orderNumber) {
                    orderState.orderNumber = generateUniqueOrderNumber();
                }
                
                const total = (orderState.formData.quantity * BIBLE_PRICE) + SHIPPING_COST;
                
                console.log('Step 2 - Order number:', orderState.orderNumber);
                console.log('Step 2 - Calculated total:', total);
                
                // Store total amount
                orderState.totalAmount = total;
                
                console.log('Stored in orderState:', {
                    orderNumber: orderState.orderNumber,
                    totalAmount: orderState.totalAmount
                });
                
                // Update step 2 display
                const orderNumberStep2 = document.getElementById('orderNumberStep2');
                const totalAmountStep2 = document.getElementById('totalAmountStep2');
                
                if (orderNumberStep2) {
                    orderNumberStep2.textContent = orderState.orderNumber;
                    console.log('Updated step 2 order number display');
                }
                if (totalAmountStep2) {
                    totalAmountStep2.textContent = total;
                    console.log('Updated step 2 total amount display');
                }
                
                // Save session with updated data
                saveSession();
                
                // Open Swish automatically
                setTimeout(() => {
                    const message = `Bibel beställning ${orderState.orderNumber}`;
                    openSwishPayment(total, message);
                }, 1000);
                
            } else if (orderState.currentStep === 3) {
                // Prepare email step
                console.log('Preparing email step with orderState:', {
                    orderNumber: orderState.orderNumber,
                    totalAmount: orderState.totalAmount,
                    formData: orderState.formData
                });
                prepareEmailStep();
                saveSession();
            }
            
            updateStepIndicator();
            showFormSection(orderState.currentStep);
            
            // Scroll to top of form
            document.querySelector('.order-form').scrollIntoView({ 
                behavior: 'smooth', 
                block: 'start' 
            });
        }

        function prepareEmailStep() {
            // Calculate total amount
            const totalAmount = (orderState.formData.quantity * BIBLE_PRICE) + SHIPPING_COST;
            
            // Create complete order object
            const orderData = {
                orderNumber: orderState.orderNumber,
                timestamp: new Date().toISOString(),
                customer: {
                    fullName: orderState.formData.fullName,
                    firstName: orderState.formData.firstName,
                    lastName: orderState.formData.lastName,
                    email: orderState.formData.email,
                    phone: orderState.formData.phone
                },
                delivery: {
                    street: orderState.formData.street,
                    postalCode: orderState.formData.postalCode,
                    city: orderState.formData.city,
                    country: orderState.formData.country
                },
                items: [{
                    product: 'Svenska Reformationsbibeln',
                    quantity: orderState.formData.quantity,
                    unitPrice: BIBLE_PRICE,
                    subtotal: orderState.formData.quantity * BIBLE_PRICE
                }],
                pricing: {
                    subtotal: orderState.formData.quantity * BIBLE_PRICE,
                    shipping: SHIPPING_COST,
                    total: totalAmount
                }
            };
            
            console.log('Order data for email:', orderData);
            console.log('Order number:', orderState.orderNumber);
            console.log('Total amount:', totalAmount);
            
            // Generate email data and store it
            const emailData = composeOrderEmail(orderData);
            storedEmailData = emailData;
            
            // Update step 3 display
            const orderNumberStep3 = document.getElementById('orderNumberStep3');
            if (orderNumberStep3) {
                orderNumberStep3.textContent = orderState.orderNumber;
                console.log('Updated step 3 order number display');
            }
            
            // Store order data
            try {
                localStorage.setItem('lastOrder', JSON.stringify(orderData));
                localStorage.setItem('lastEmailData', JSON.stringify(emailData));
                console.log('Order and email data saved');
            } catch (e) {
                console.log('Could not save to localStorage:', e);
            }
        }

        function prevStep() {
            console.log('Previous step called, current step:', orderState.currentStep);
            
            hideError();
            if (orderState.currentStep > 1) {
                orderState.currentStep--;
                console.log('Moving to step:', orderState.currentStep);
                updateStepIndicator();
                showFormSection(orderState.currentStep);
                
                // Scroll to top of form
                document.querySelector('.order-form').scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'start' 
                });
            }
        }

        // Validation
        function validateCurrentStep() {
            console.log('Validating step:', orderState.currentStep);
            
            switch (orderState.currentStep) {
                case 1:
                    return validateAllFormData();
                case 2:
                    return true; // Swish payment step - no validation needed
                case 3:
                    return true; // Email step - no validation needed
                default:
                    return false;
            }
        }

        function validateAllFormData() {
            console.log('Validating all form data');
            
            // Validate quantity
            if (orderState.quantity <= 0) {
                showError('Vänligen välj antal biblar.');
                return false;
            }

            // Validate contact info
            const firstName = document.getElementById('firstName').value.trim();
            const lastName = document.getElementById('lastName').value.trim();
            const email = document.getElementById('email').value.trim();
            const phone = document.getElementById('phone').value.trim();

            if (!firstName || !lastName || !email || !phone) {
                showError('Vänligen fyll i alla obligatoriska kontaktfält.');
                return false;
            }

            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                showError('Vänligen ange en giltig e-postadress.');
                return false;
            }

            const phoneRegex = /^[\d\s\-\+\(\)]+$/;
            if (!phoneRegex.test(phone)) {
                showError('Vänligen ange ett giltigt telefonnummer.');
                return false;
            }

            // Validate delivery info
            const street = document.getElementById('street').value.trim();
            const postalCode = document.getElementById('postalCode').value.trim();
            const city = document.getElementById('city').value.trim();

            if (!street || !postalCode || !city) {
                showError('Vänligen fyll i alla obligatoriska adressfält.');
                return false;
            }

            const postalCodeRegex = /^\d{3}\s?\d{2}$/;
            if (!postalCodeRegex.test(postalCode)) {
                showError('Vänligen ange ett giltigt postnummer (t.ex. 123 45).');
                return false;
            }

            console.log('All validation passed');
            return true;
        }

        // Data management
        function saveCurrentStepData() {
            console.log('Saving data for step:', orderState.currentStep);
            
            if (orderState.currentStep === 1) {
                // Save all data from step 1
                orderState.formData.quantity = orderState.quantity;
                orderState.formData.firstName = document.getElementById('firstName').value.trim();
                orderState.formData.lastName = document.getElementById('lastName').value.trim();
                orderState.formData.fullName = `${orderState.formData.firstName} ${orderState.formData.lastName}`;
                orderState.formData.email = document.getElementById('email').value.trim();
                orderState.formData.phone = document.getElementById('phone').value.trim();
                orderState.formData.street = document.getElementById('street').value.trim();
                orderState.formData.postalCode = document.getElementById('postalCode').value.trim();
                orderState.formData.city = document.getElementById('city').value.trim();
                orderState.formData.country = document.getElementById('country').value;
                
                console.log('Saved all form data:', orderState.formData);
            }
        }

        // Order summary generation
        function generateOrderSummary() {
            console.log('Generating order summary');
            console.log('Current form data:', orderState.formData);
            
            // Ensure all data is available
            if (!orderState.formData.quantity) {
                orderState.formData.quantity = orderState.quantity;
            }
            
            const data = orderState.formData;
            const subtotalAmount = data.quantity * BIBLE_PRICE;
            const totalAmount = subtotalAmount + SHIPPING_COST;

            console.log('Summary calculation:', {
                quantity: data.quantity,
                subtotal: subtotalAmount,
                shipping: SHIPPING_COST,
                total: totalAmount
            });

            const summaryHTML = `
                <h3 style="color: var(--primary-text); margin-bottom: 1rem;">Orderöversikt</h3>
                
                <div class="price-line">
                    <strong>Produkt:</strong> Svenska Reformationsbibeln
                </div>
                <div class="price-line">
                    <strong>Antal:</strong> ${data.quantity} st
                </div>
                <div class="price-line">
                    <strong>Pris per bok:</strong> ${BIBLE_PRICE} kr
                </div>
                <div class="price-line">
                    <strong>Frakt:</strong> ${SHIPPING_COST} kr
                </div>
                <div class="price-line total">
                    <strong>Totalt:</strong> ${totalAmount} kr
                </div>

                <hr style="margin: 1.5rem 0; border: 1px solid var(--border-color);">

                <h4 style="color: var(--primary-text); margin-bottom: 1rem;">Kontaktuppgifter</h4>
                <p><strong>Namn:</strong> ${data.firstName || 'Ej angivet'} ${data.lastName || ''}</p>
                <p><strong>E-post:</strong> ${data.email || 'Ej angivet'}</p>
                <p><strong>Telefon:</strong> ${data.phone || 'Ej angivet'}</p>

                <h4 style="color: var(--primary-text); margin: 1rem 0;">Leveransadress</h4>
                <p>${data.street || 'Ej angivet'}<br>
                ${data.postalCode || ''} ${data.city || ''}<br>
                ${data.country || 'Sverige'}</p>
            `;

            const summaryElement = document.getElementById('orderSummary');
            if (summaryElement) {
                summaryElement.innerHTML = summaryHTML;
                console.log('Order summary generated and inserted successfully');
            } else {
                console.error('Order summary element not found');
            }
        }

        // Email composition
        function composeOrderEmail(orderData) {
            // Fallback values in case of undefined data
            const orderNumber = orderData.orderNumber || generateUniqueOrderNumber();
            const totalAmount = orderData.pricing?.total || ((orderData.items?.[0]?.quantity || 1) * BIBLE_PRICE + SHIPPING_COST);
            
            console.log('Email composition data check:', {
                orderNumber: orderNumber,
                totalAmount: totalAmount,
                fullOrderData: orderData
            });
            
            const subject = `BESTÄLLNING ${orderNumber} - Svenska Reformationsbibeln`;
            
            const emailBody = `ORDERBEKRÄFTELSE - ${orderNumber}

En ny beställning har registrerats:

══════════════════════════════════════
ORDERNUMMER: ${orderNumber}
DATUM: ${new Date(orderData.timestamp).toLocaleString('sv-SE')}
══════════════════════════════════════

KUNDUPPGIFTER:
Namn: ${orderData.customer?.fullName || 'Ej angivet'}
E-post: ${orderData.customer?.email || 'Ej angivet'}
Telefon: ${orderData.customer?.phone || 'Ej angivet'}

LEVERANSADRESS:
${orderData.delivery?.street || 'Ej angivet'}
${orderData.delivery?.postalCode || ''} ${orderData.delivery?.city || ''}
${orderData.delivery?.country || 'Sverige'}

BESTÄLLNING:
${orderData.items?.map(item => `${item.quantity} x ${item.product} à ${item.unitPrice} kr = ${item.subtotal} kr`).join('\n') || '1 x Svenska Reformationsbibeln à 200 kr = 200 kr'}

Frakt: ${orderData.pricing?.shipping || SHIPPING_COST} kr
══════════════════════════════════════
TOTALT: ${totalAmount} kr
══════════════════════════════════════

BETALNING: Swish till ${orderData.customer?.phone || 'Ej angivet'}
STATUS: Betalning genomförd via Swish

Skicka varan till leveransadressen ovan.

// Ordernummer för verifiering: ${orderNumber}`;

            // Create mailto link with obfuscated email
            const mailtoLink = `mailto:postATbibel.se?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(emailBody)}`;
            
            return { subject, emailBody, mailtoLink };
        }

        // Email sending function with multiple client support
        function sendOrderEmail() {
            console.log('sendOrderEmail called');
            
            if (!storedEmailData) {
                console.error('No stored email data found');
                alert('Ingen beställningsdata hittades. Vänligen kontakta postATbibel.se manuellt.');
                return;
            }

            console.log('Email data found, attempting to open email compose...');
            console.log('Subject:', storedEmailData.subject);
            
            const orderNumberElement = document.getElementById('orderNumber');
            const orderNumber = orderNumberElement ? orderNumberElement.textContent : 'UNKNOWN';
            
            // Gmail URL
            const gmailUrl = `https://mail.google.com/mail/?view=cm&fs=1&to=postATbibel.se&su=${encodeURIComponent(storedEmailData.subject)}&body=${encodeURIComponent(storedEmailData.emailBody)}`;
            console.log('Gmail URL generated');
            
            // Outlook URL
            const outlookUrl = `https://outlook.live.com/mail/0/deeplink/compose?to=postATbibel.se&subject=${encodeURIComponent(storedEmailData.subject)}&body=${encodeURIComponent(storedEmailData.emailBody)}`;
            console.log('Outlook URL generated');
            
            // Helper function to try opening email clients
            function tryEmailClient(url, clientName) {
                return new Promise((resolve, reject) => {
                    console.log(`Trying to open ${clientName}...`);
                    try {
                        const newWindow = window.open(url, '_blank');
                        if (newWindow && !newWindow.closed) {
                            console.log(`${clientName} window opened successfully`);
                            resolve(clientName);
                        } else {
                            console.log(`${clientName} window was blocked or failed to open`);
                            reject(`${clientName} blocked by popup blocker`);
                        }
                    } catch (error) {
                        console.log(`${clientName} failed with error:`, error);
                        reject(`${clientName} failed: ${error.message}`);
                    }
                });
            }

            // Try Gmail first
            tryEmailClient(gmailUrl, 'Gmail')
                .then((success) => {
                    console.log(`${success} opened successfully`);
                })
                .catch((error) => {
                    console.log('Gmail failed:', error);
                    console.log('Trying Outlook as fallback...');
                    
                    // Try Outlook as fallback
                    tryEmailClient(outlookUrl, 'Outlook')
                        .then((success) => {
                            console.log(`${success} opened successfully`);
                        })
                        .catch((error) => {
                            console.log('Outlook failed:', error);
                            console.log('Trying mailto as final fallback...');
                            
                            // Try mailto as final fallback
                            try {
                                console.log('Attempting mailto...');
                                window.location.href = storedEmailData.mailtoLink;
                                console.log('Mailto link executed');
                            } catch (mailtoError) {
                                console.log('All email methods failed. Mailto error:', mailtoError);
                                console.log('Showing manual email dialog...');
                                
                                // Show manual copy dialog
                                showManualEmailDialog(orderNumber);
                            }
                        });
                });
        }

        // Show manual email instructions if all automated methods fail
        function showManualEmailDialog(orderNumber) {
            const emailContent = `
Ämne: ${storedEmailData.subject}

Till: postATbibel.se

Meddelande:
${storedEmailData.emailBody}
            `.trim();

            // Create a modal-like dialog
            const dialog = document.createElement('div');
            dialog.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
            `;

            dialog.innerHTML = `
                <div style="
                    background: white;
                    padding: 2rem;
                    border-radius: 12px;
                    max-width: 600px;
                    max-height: 80vh;
                    overflow-y: auto;
                    margin: 1rem;
                    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
                ">
                    <h3 style="color: var(--primary-text); margin-bottom: 1rem;">
                        <i class="fas fa-envelope"></i> Skicka e-post manuellt
                    </h3>
                    <p style="margin-bottom: 1rem; color: var(--primary-text);">
                        E-postklienten kunde inte öppnas automatiskt. Kopiera texten nedan och skicka ett e-post till <strong>postATbibel.se</strong>:
                    </p>
                    <textarea readonly style="
                        width: 100%;
                        height: 300px;
                        padding: 1rem;
                        border: 2px solid var(--border-color);
                        border-radius: 6px;
                        font-family: monospace;
                        font-size: 0.9rem;
                        resize: vertical;
                        background: #f9f9f9;
                    ">${emailContent}</textarea>
                    <div style="margin-top: 1rem; display: flex; gap: 1rem; justify-content: flex-end;">
                        <button onclick="copyEmailContent()" style="
                            background: var(--gradient-gold);
                            color: #2b1d00;
                            border: none;
                            padding: 0.8rem 1.2rem;
                            border-radius: 6px;
                            cursor: pointer;
                            font-weight: 600;
                        ">
                            <i class="fas fa-copy"></i> Kopiera text
                        </button>
                        <button onclick="closeEmailDialog()" style="
                            background: rgba(139, 105, 20, 0.1);
                            color: var(--primary-text);
                            border: 2px solid var(--border-color);
                            padding: 0.8rem 1.2rem;
                            border-radius: 6px;
                            cursor: pointer;
                            font-weight: 600;
                        ">
                            Stäng
                        </button>
                    </div>
                </div>
            `;

            document.body.appendChild(dialog);
            
            // Store dialog reference for cleanup
            window.currentEmailDialog = dialog;

            // Add global functions for the dialog buttons
            window.copyEmailContent = function() {
                const textarea = dialog.querySelector('textarea[readonly]');
                if (textarea) {
                    textarea.select();
                    textarea.setSelectionRange(0, 99999); // For mobile devices
                    
                    try {
                        document.execCommand('copy');
                        alert('E-postinnehåll kopierat! Klistra in i din e-postklient och skicka till postATbibel.se');
                    } catch (err) {
                        console.log('Copy failed:', err);
                        alert('Kunde inte kopiera automatiskt. Markera och kopiera texten manuellt.');
                    }
                }
            };

            window.closeEmailDialog = function() {
                if (window.currentEmailDialog) {
                    document.body.removeChild(window.currentEmailDialog);
                    window.currentEmailDialog = null;
                }
            };
        }

        // Order submission
        function submitOrder() {
            console.log('Submitting order...');
            
        // Generate truly unique order number with better entropy
        function generateUniqueOrderNumber() {
            const now = new Date();
            const year = now.getFullYear().toString().slice(-2);
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hour = String(now.getHours()).padStart(2, '0');
            const minute = String(now.getMinutes()).padStart(2, '0');
            
            // Generate random string
            const randomChars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let randomString = '';
            for (let i = 0; i < 6; i++) {
                randomString += randomChars.charAt(Math.floor(Math.random() * randomChars.length));
            }
            
            // Combine timestamp and random for uniqueness
            const timestamp = Date.now().toString(36).toUpperCase();
            
            return `SRB-${year}${month}${day}-${hour}${minute}-${randomString}-${timestamp}`;
        }
            
            // Calculate total
            const total = (orderState.formData.quantity * BIBLE_PRICE) + SHIPPING_COST;
            
            // Create complete order object
            const orderData = {
                orderNumber,
                timestamp: new Date().toISOString(),
                customer: {
                    fullName: orderState.formData.fullName,
                    firstName: orderState.formData.firstName,
                    lastName: orderState.formData.lastName,
                    email: orderState.formData.email,
                    phone: orderState.formData.phone
                },
                delivery: {
                    street: orderState.formData.street,
                    postalCode: orderState.formData.postalCode,
                    city: orderState.formData.city,
                    country: orderState.formData.country
                },
                items: [{
                    product: 'Svenska Reformationsbibeln',
                    quantity: orderState.formData.quantity,
                    unitPrice: BIBLE_PRICE,
                    subtotal: orderState.formData.quantity * BIBLE_PRICE
                }],
                pricing: {
                    subtotal: orderState.formData.quantity * BIBLE_PRICE,
                    shipping: SHIPPING_COST,
                    total: total
                }
            };
            
            // Generate email data and store it
            const emailData = composeOrderEmail(orderData);
            storedEmailData = emailData;
            
            // In a real application, this would submit to a server
            console.log('Order data:', orderData);
            console.log('Email data stored for manual sending');
            
            // Store in localStorage for demo purposes
            try {
                localStorage.setItem('lastOrder', JSON.stringify(orderData));
                localStorage.setItem('lastEmailData', JSON.stringify(emailData));
                console.log('Order and email data saved to localStorage');
            } catch (e) {
                console.log('Could not save to localStorage:', e);
            }

            // Show success message
            const orderNumberElement = document.getElementById('orderNumber');
            if (orderNumberElement) {
                orderNumberElement.textContent = orderNumber;
            }
            
            // Hide all form sections and show success
            document.querySelectorAll('.form-section').forEach(section => {
                section.style.display = 'none';
                section.classList.remove('active');
            });
            
            const successSection = document.querySelector('[data-section="success"]');
            if (successSection) {
                successSection.style.display = 'block';
                successSection.classList.add('active');
            }

            // Update step indicator to show completion
            document.querySelectorAll('.step').forEach(step => {
                step.classList.remove('active');
                step.classList.add('completed');
                step.querySelector('.step-number').innerHTML = '<i class="fas fa-check"></i>';
            });

            // Open Swish payment after a delay
            setTimeout(() => {
                const message = `Bibel beställning ${orderNumber}`;
                openSwishPayment(total, message);
            }, 2000);
        }

        // Swish payment integration
        function openSwishPayment(amount, message) {
            console.log('Opening Swish payment for:', amount, 'kr');
            
            const swishData = {
                "version": 1,
                "payee": {
                    "value": "1233882669",
                    "editable": false
                },
                "amount": {
                    "value": amount,
                    "editable": false
                },
                "message": {
                    "value": message,
                    "editable": false
                }
            };

            const jsonUrl = `swish://payment?data=${encodeURIComponent(JSON.stringify(swishData))}`;

            try {
                window.location.href = jsonUrl;
                console.log('Swish opened with JSON format');
                return;
            } catch (error) {
                console.log('JSON format failed:', error);
            }

            // Fallback methods
            const fallbackUrls = [
                `swish://payment?phone=1233882669&amount=${amount}&message=${encodeURIComponent(message)}`,
                `swish://paymentrequest?phone=1233882669&amount=${amount}&message=${encodeURIComponent(message)}`,
                `swish://payment?phone=1233882669&amount=${amount}`,
                `swish://payment?phone=1233882669`
            ];

            for (let url of fallbackUrls) {
                try {
                    window.location.href = url;
                    return;
                } catch (error) {
                    console.log('Fallback failed:', error);
                }
            }

            try {
                window.location.href = "swish://";
            } catch (error) {
                console.log('Could not open Swish app');
                alert('Kunde inte öppna Swish. Kontrollera att Swish-appen är installerad.');
            }
        }

        // Error handling
        function showError(message) {
            if (errorMessage) {
                errorMessage.textContent = message;
                errorMessage.style.display = 'block';
                errorMessage.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        }

        function hideError() {
            if (errorMessage) {
                errorMessage.style.display = 'none';
            }
        }

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        // Smooth scrolling for internal links
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();
                const target = document.querySelector(this.getAttribute('href'));
                if (target) {
                    const headerHeight = document.querySelector('.header').offsetHeight;
                    const targetPosition = target.offsetTop - headerHeight - 20;

                    window.scrollTo({
                        top: targetPosition,
                        behavior: 'smooth'
                    });
                }
            });
        });

        // Prevent zoom on double-tap for iOS Safari
        let lastTouchEnd = 0;
        document.addEventListener('touchend', function (event) {
            const now = (new Date()).getTime();
            if (now - lastTouchEnd <= 300) {
                event.preventDefault();
            }
            lastTouchEnd = now;
        }, false);
    </script>
</body>

</html>