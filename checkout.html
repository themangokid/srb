<!DOCTYPE html>
<html lang="sv">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=3.0, user-scalable=yes">
    <!-- QR -->
    <!-- Icons-->
    <link rel="icon" type="image/png" href="favicon/favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/svg+xml" href="favicon/favicon.svg" />
    <link rel="shortcut icon" href="favicon/favicon.ico" />
    <link rel="apple-touch-icon" sizes="180x180" href="favicon/apple-touch-icon.png" />

    <!-- Fonts and styles-->
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="checkout.css">
    <title>Svenska Reformationsbibeln - Beställning</title>
    <link href="https://fonts.googleapis.com/css2?family=EB+Garamond:wght@400;500;600;700&display=swap"
        rel="stylesheet">
    <!-- Add Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">



</head>

<body>
    <!-- Header -->
    <header class="header">
        <nav class="nav-container">
            <div class="logo">
                <a href="index.html">
                    <div class="logo-icon"></div>
                </a>
            </div>
            <ul class="nav-menu">
                <li><a href="index.html">Hem</a></li>
                <li><a href="QnA.html">Frågor & svar</a></li>
                <li><a href="index.html#resurser">Resurser</a></li>
                <li><a href="https://bibel.se" target="_blank">Bibel.se</a></li>
                <li><a href="index.html#kontakt">Kontakt</a></li>
                <li><a href="#" id="settingsBtn"><i class="fas fa-cog"></i> Inställningar</a></li>
            </ul>
            <div class="hamburger">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </nav>
    </header>

    <div class="order-container">
        <h1 style="text-align: center; color: var(--primary-text); margin-bottom: 2rem; font-size: 2.5rem;">
            Beställ Svenska Reformationsbibeln
        </h1>

        <!-- Step Indicator -->
        <div class="step-indicator">
            <div class="step active clickable" data-step="1">
                <div class="step-number">1</div>
                <span>Formulär</span>
            </div>
            <div class="step clickable" data-step="2">
                <div class="step-number">2</div>
                <span>Swish (Betala)</span>
            </div>
            <div class="step clickable" data-step="3">
                <div class="step-number">3</div>
                <span>Skicka info via e-post</span>
            </div>
        </div>

        <!-- Order Form -->
        <div class="order-form">
            <div class="error-message" id="errorMessage"></div>


            <!-- Step 1: Complete Order Form -->
            <div class="form-section active" data-section="1">
                <h2><i class="fas fa-shopping-cart"></i> Beställningsuppgifter</h2>

                <!-- Quantity Selection -->
                <div
                    style="background: rgba(139, 105, 20, 0.05); border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem; border: 1px solid var(--border-color);">
                    <h3 style="color: var(--primary-text); margin-bottom: 1rem; font-size: 1.3rem;">
                        <i class="fas fa-book"></i> Välj antal
                    </h3>

                    <div class="info-box">
                        <p><strong>Endast förskottsbetalning</strong> – För att förenkla administration och utskick från
                            vårt lager i Haparanda, så återgår vi till förskottsinbetalning.
                    </div>
                    <div class="info-box">
                        <p><strong>Svenska Reformationsbibeln</strong> - En modern översättning av Karl XII:s Bibel från
                            1703, baserad på Textus Receptus.
                            <strong> Pris: 200 kr per exemplar + frakt.</strong></p>
                    </div>

                    <div class="quantity-selector">
                        <button type="button" class="quantity-btn" id="decreaseBtn">−</button>
                        <div class="quantity-display" id="quantityDisplay">1</div>
                        <button type="button" class="quantity-btn" id="increaseBtn">+</button>
                    </div>

                    <div class="price-summary">
                        <div class="price-line">
                            <span>Biblar (<span id="summaryQuantity">1</span> st):</span>
                            <span id="subtotal">200 kr</span>
                        </div>
                        <div class="price-line">
                            <span>Frakt:</span>
                            <span id="shipping">49 kr</span>
                        </div>
                        <div class="price-line total">
                            <span>Totalt:</span>
                            <span id="total">249 kr</span>
                        </div>
                    </div>
                </div>

                <!-- Contact Information -->
                <div
                    style="background: rgba(139, 105, 20, 0.05); border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem; border: 1px solid var(--border-color);">
                    <h3 style="color: var(--primary-text); margin-bottom: 1rem; font-size: 1.3rem;">
                        <i class="fas fa-user"></i> Kontaktuppgifter
                    </h3>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group required">
                            <label for="firstName">Förnamn</label>
                            <input type="text" id="firstName" name="given-name" autocomplete="given-name" required>
                        </div>

                        <div class="form-group required">
                            <label for="lastName">Efternamn</label>
                            <input type="text" id="lastName" name="family-name" autocomplete="family-name" required>
                        </div>
                    </div>

                    <div class="form-group required">
                        <label for="email">E-postadress</label>
                        <input type="email" id="email" name="email" autocomplete="email" required>
                    </div>

                    <div class="form-group required">
                        <label for="phone">Telefonnummer (för Swish-betalning)</label>
                        <input type="tel" id="phone" name="tel" autocomplete="tel" placeholder="070-123 45 67" required>
                    </div>
                </div>

                <!-- Delivery Information -->
                <div
                    style="background: rgba(139, 105, 20, 0.05); border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem; border: 1px solid var(--border-color);">
                    <h3 style="color: var(--primary-text); margin-bottom: 1rem; font-size: 1.3rem;">
                        <i class="fas fa-truck"></i> Leveransadress
                    </h3>

                    <div class="form-group required">
                        <label for="street">Gatuadress</label>
                        <input type="text" id="street" name="address-line1" autocomplete="address-line1"
                            placeholder="Gatunamn och nummer" required>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 1rem;">
                        <div class="form-group required">
                            <label for="postalCode">Postnummer</label>
                            <input type="text" id="postalCode" name="postal-code" autocomplete="postal-code"
                                placeholder="123 45" pattern="[0-9]{3}\s?[0-9]{2}" required>
                        </div>

                        <div class="form-group required">
                            <label for="city">Ort</label>
                            <input type="text" id="city" name="address-level2" autocomplete="address-level2" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="country">Land</label>
                        <select id="country" name="country" autocomplete="country">
                            <option value="Sverige" selected>Sverige</option>
                            <option value="Norge">Norge</option>
                            <option value="Danmark">Danmark</option>
                            <option value="Finland">Finland</option>
                            <option value="Island">Island</option>
                        </select>
                    </div>
                </div>

                <div class="btn-group">
                    <div></div>
                    <button type="button" class="btn btn-primary" id="nextStepBtn">
                        Nästa steg <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
            </div>
<!-- Step 2: Swish Payment -->
<div class="form-section" data-section="2">
    <div style="background: rgba(212, 175, 55, 0.05); border: 2px solid var(--primary-gold); border-radius: 12px; padding: 2rem; margin: 2rem auto; max-width: 600px;">
        <div style="text-align: center;">
            <i class="fas fa-mobile-alt" style="font-size: 4rem; color: #2d5f3f; margin-bottom: 1.5rem;"></i>
            <h2 style="font-size: 2rem; margin-bottom: 1rem;">Betala med Swish</h2>
            <p style="font-size: 1.3rem; margin-bottom: 1.5rem;">Skanna QR-koden för att betala</p>
            
            
            <div style="background: rgba(46, 125, 50, 0.1); border: 2px solid #2d5f3f; border-radius: 12px; padding: 1.5rem;">
                <p style="font-size: 1.1rem; margin: 0;"><strong>Ordernummer:</strong> <span id="orderNumberStep2"></span></p>
                <p style="font-size: 1.1rem; margin: 0.5rem 0 0 0;"><strong>Belopp:</strong> <span id="totalAmountStep2"></span> kr</p>
            </div>
        </div>
    </div>
    
    <div class="btn-group" style="margin-top: 2rem;">
        <button type="button" class="btn btn-secondary" id="prevStepBtn">
            <i class="fas fa-arrow-left"></i> Tillbaka
        </button>
        <button type="button" class="btn btn-primary" id="proceedToEmailBtn">
            Betalning klar - Nästa steg <i class="fas fa-arrow-right"></i>
        </button>
    </div>
</div>

        <!-- Step 3: Send Email -->
        <div class="form-section" data-section="3">
            <div style="text-align: center; padding: 2rem;">
                <i class="fas fa-envelope" style="font-size: 4rem; color: #d4af37; margin-bottom: 1.5rem;"></i>
                <h2 style="font-size: 2rem; margin-bottom: 1rem;">Skicka orderbekräftelse</h2>
                <p style="font-size: 1.3rem; margin-bottom: 1.8rem;">Välj hur du vill skicka beställningen till oss.
                    <br> Dubbelkolla i "skickade mail" så att vi säkert ha fått din order.</p>


                <div
                    style="background: rgba(139, 105, 20, 0.1); border: 2px solid var(--primary-gold); border-radius: 12px; padding: 1.5rem; margin: 1.5rem auto; max-width: 500px;">
                    <p style="font-size: 1.2rem; margin: 0;"><strong>Ordernummer:</strong> <span
                            id="orderNumberStep3"></span></p>
                    <p style="font-size: 1.3rem; margin: 0.5rem 0 0 0;"> <strong> Till: </strong> post@bibel.se </p>
                </div>


                <!-- Email Options -->
                <div
                    style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin: 2rem 0; max-width: 600px; margin-left: auto; margin-right: auto;">

                    <!-- Default Email App - RECOMMENDED FOR MOBILE -->
                    <button class="email-option-btn email-option-recommended" data-service="default">
                        <span class="recommended-badge">Rekommenderat</span>
                        <i class="fas fa-envelope" style="color: #d4af37;"></i>
                        <span>E-postapp (Mejlprogram)</span>
                    </button>
                    <!-- Gmail -->
                    <button class="email-option-btn" data-service="gmail">
                        <i class="fab fa-google" style="color: #EA4335;"></i>
                        <span>Gmail</span>
                    </button>
                    <!-- Outlook -->
                    <button class="email-option-btn" data-service="outlook">
                        <i class="fab fa-microsoft" style="color: #0078D4;"></i>
                        <span>Outlook</span>
                    </button>
                    <!-- Copy to Clipboard -->
                    <button class="email-option-btn" data-service="copy">
                        <i class="fas fa-copy" style="color: #28a745;"></i>
                        <span>Kopiera</span>
                    </button>
                </div>
                <div class="btn-group" style="margin-top: 2rem;">
                    <button type="button" class="btn btn-secondary" id="prevStepBtn2">
                        <i class="fas fa-arrow-left"></i> Tillbaka
                    </button>
                </div>
            </div>
        </div>

        <!--. <div style="background: rgba(46, 125, 50, 0.1); border-left: 4px solid #2d5f3f; padding: 1rem; margin: 1.5rem auto; border-radius: 0 8px 8px 0; max-width: 500px; text-align: left;">
                        <h4 style="margin-bottom: 0.5rem; font-size: 1.1rem;"><i class="fas fa-check-circle" style="color: #2d5f3f; margin-right: 0.5rem;"></i>Efter e-post skickad:</h4>
                    </div> -->
        <!-- <p style="margin: 0; font-size: 1rem;">Din beställning behandlas och skickas inom 3-5 arbetsdagar. Du får en bekräftelse när ordern är på väg.</p> -->
    </div>
    </div>
    </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-cog"></i> Beställningsinställningar</h2>
                <span class="close" id="closeSettings">&times;</span>
            </div>
            <div class="modal-body">
                <div class="settings-section">
                    <h3><i class="fas fa-history"></i> Tidigare beställningar</h3>
                    <div id="ordersList" class="orders-list">
                        <!-- Orders will be populated by JavaScript -->
                    </div>
                </div>

                <div class="settings-section">
                    <h3><i class="fas fa-tools"></i> Åtgärder</h3>
                    <div class="settings-actions">
                        <button class="btn btn-secondary" id="newOrderBtn">
                            <i class="fas fa-plus"></i> Ny beställning
                        </button>
                        <button class="btn btn-warning" id="clearDataBtn">
                            <i class="fas fa-trash"></i> Rensa all data
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->

    <style>

    </style>

    <script>
        // Order state management with session persistence
        let orderState = {
            quantity: 1,
            currentStep: 1,
            formData: {},
            orderNumber: null,
            totalAmount: null,
            sessionId: null
        };

        // Pricing configuration
        const BIBLE_PRICE = 200;
        const SHIPPING_COST = 49;

        // Global variable to store email data
        let storedEmailData = null;

        // DOM elements - will be initialized after DOM loads
        let quantityDisplay, summaryQuantity, subtotal, shipping, total, errorMessage;

        // Generate truly unique order number with better entropy
        function generateUniqueOrderNumber() {
            const now = new Date();
            const year = now.getFullYear().toString().slice(-2);
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hour = String(now.getHours()).padStart(2, '0');
            const minute = String(now.getMinutes()).padStart(2, '0');

            // Generate random string
            const randomChars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let randomString = '';
            for (let i = 0; i < 6; i++) {
                randomString += randomChars.charAt(Math.floor(Math.random() * randomChars.length));
            }

            // Combine timestamp and random for uniqueness
            const timestamp = Date.now().toString(36).toUpperCase();

            return `SRB-${year}${month}${day}-${hour}${minute}-${randomString}-${timestamp}`;
        }

        // Session management
        function createOrResumeSession() {
            // Check if there's an existing session in URL or localStorage
            const urlParams = new URLSearchParams(window.location.search);
            const urlOrderNumber = urlParams.get('order');

            // Try to get existing session
            let existingSession = null;
            if (urlOrderNumber) {
                existingSession = loadSessionByOrderNumber(urlOrderNumber);
            } else {
                existingSession = loadLastSession();
            }

            if (existingSession) {
                // Resume existing session
                console.log('Resuming existing session:', existingSession.orderNumber);
                orderState = {
                    ...orderState,
                    ...existingSession
                };
                restoreFormFromSession();
                updateAllDisplays();
                return true;
            } else {
                // Create new session
                const newOrderNumber = generateUniqueOrderNumber();
                orderState.orderNumber = newOrderNumber;
                orderState.sessionId = newOrderNumber;
                console.log('Created new session:', newOrderNumber);
                saveSession();
                return false;
            }
        }

        function saveSession() {
            const sessionData = {
                ...orderState,
                timestamp: new Date().toISOString(),
                lastActivity: Date.now()
            };

            try {
                localStorage.setItem(`order_${orderState.orderNumber}`, JSON.stringify(sessionData));
                localStorage.setItem('lastOrderNumber', orderState.orderNumber);
                console.log('Session saved:', orderState.orderNumber);

                // Update URL without page reload
                const url = new URL(window.location);
                url.searchParams.set('order', orderState.orderNumber);
                window.history.replaceState({}, '', url);
            } catch (e) {
                console.error('Failed to save session:', e);
            }
        }

        function loadSessionByOrderNumber(orderNumber) {
            try {
                const sessionData = localStorage.getItem(`order_${orderNumber}`);
                if (sessionData) {
                    return JSON.parse(sessionData);
                }
            } catch (e) {
                console.error('Failed to load session:', e);
            }
            return null;
        }

        function loadLastSession() {
            try {
                const lastOrderNumber = localStorage.getItem('lastOrderNumber');
                if (lastOrderNumber) {
                    return loadSessionByOrderNumber(lastOrderNumber);
                }
            } catch (e) {
                console.error('Failed to load last session:', e);
            }
            return null;
        }

        function restoreFormFromSession() {
            if (orderState.formData && Object.keys(orderState.formData).length > 0) {
                // Restore form fields
                const fields = [
                    'firstName', 'lastName', 'email', 'phone',
                    'street', 'postalCode', 'city', 'country'
                ];

                fields.forEach(field => {
                    const element = document.getElementById(field);
                    if (element && orderState.formData[field]) {
                        element.value = orderState.formData[field];
                    }
                });

                // Restore quantity
                if (orderState.quantity) {
                    updateQuantityDisplay();
                    updatePricing();
                }

                console.log('Form restored from session');
            }
        }

        function updateAllDisplays() {
            // Update step indicator
            updateStepIndicator();

            // Show current step
            showFormSection(orderState.currentStep);

            // Update order number displays
            const orderNumberElements = [
                'orderNumberStep2',
                'orderNumberStep3'
            ];

            orderNumberElements.forEach(id => {
                const element = document.getElementById(id);
                if (element && orderState.orderNumber) {
                    element.textContent = orderState.orderNumber;
                }
            });

            // Update total amount displays
            if (orderState.totalAmount) {
                const totalElement = document.getElementById('totalAmountStep2');
                if (totalElement) {
                    totalElement.textContent = orderState.totalAmount;
                }
            }

            // FIX: Prepare email data if we're on step 3 and don't have it
            if (orderState.currentStep === 3 && !storedEmailData) {
                console.log('Preparing email data for resumed session');
                prepareEmailStep();
            }
        }

        // Settings and orders management
        function getAllOrders() {
            const orders = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('order_')) {
                    try {
                        const orderData = JSON.parse(localStorage.getItem(key));
                        orders.push(orderData);
                    } catch (e) {
                        console.error('Failed to parse order:', key, e);
                    }
                }
            }

            // Sort by timestamp, newest first
            return orders.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        }

        function displayOrders() {
            const ordersList = document.getElementById('ordersList');
            const orders = getAllOrders();

            if (orders.length === 0) {
                ordersList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-shopping-cart"></i>
                        <p>Inga tidigare beställningar hittades.</p>
                    </div>
                `;
                return;
            }

            ordersList.innerHTML = orders.map(order => {
                const date = new Date(order.timestamp).toLocaleDateString('sv-SE');
                const time = new Date(order.timestamp).toLocaleTimeString('sv-SE', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
                const stepText = ['Formulär', 'Swish (Betala)', 'Skicka info via e-post'][order.currentStep -
                    1] || 'Okänt';
                const statusClass = `status-step${order.currentStep}`;

                return `
                    <div class="order-card">
                        <div class="order-header">
                            <div class="order-number">${order.orderNumber}</div>
                            <div class="order-date">${date} ${time}</div>
                        </div>
                        
                        <div class="order-details">
                            <div><strong>Kund:</strong> ${order.formData?.fullName || 'Ej angivet'}</div>
                            <div><strong>Antal:</strong> ${order.quantity || 1} st</div>
                            <div><strong>E-post:</strong> ${order.formData?.email || 'Ej angivet'}</div>
                            <div><strong>Totalt:</strong> ${((order.quantity || 1) * BIBLE_PRICE) + SHIPPING_COST} kr</div>
                        </div>
                        
                        <div style="margin: 1rem 0;">
                            <span class="order-status ${statusClass}">Steg ${order.currentStep}: ${stepText}</span>
                        </div>
                        
                        <div class="order-actions">
                            <button class="btn btn-primary btn-small" onclick="resumeOrder('${order.orderNumber}')">
                                <i class="fas fa-play"></i> Fortsätt
                            </button>
                            <button class="btn btn-secondary btn-small" onclick="duplicateOrder('${order.orderNumber}')">
                                <i class="fas fa-copy"></i> Kopiera
                            </button>
                            <button class="btn btn-warning btn-small" onclick="deleteOrder('${order.orderNumber}')">
                                <i class="fas fa-trash"></i> Ta bort
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function resumeOrder(orderNumber) {
            const orderData = loadSessionByOrderNumber(orderNumber);
            if (orderData) {
                orderState = {
                    ...orderState,
                    ...orderData
                };
                restoreFormFromSession();
                updateAllDisplays();
                closeSettingsModal();

                // Update URL
                const url = new URL(window.location);
                url.searchParams.set('order', orderNumber);
                window.history.replaceState({}, '', url);

                console.log('Resumed order:', orderNumber);
            }
        }

        function duplicateOrder(orderNumber) {
            const orderData = loadSessionByOrderNumber(orderNumber);
            if (orderData) {
                // Create new order with same data but new order number and reset to step 1
                const newOrderNumber = generateUniqueOrderNumber();
                const duplicatedOrder = {
                    ...orderData,
                    orderNumber: newOrderNumber,
                    sessionId: newOrderNumber,
                    currentStep: 1,
                    timestamp: new Date().toISOString(),
                    lastActivity: Date.now()
                };

                orderState = duplicatedOrder;
                restoreFormFromSession();
                updateAllDisplays();
                saveSession();
                closeSettingsModal();

                console.log('Duplicated order as:', newOrderNumber);
            }
        }

        function deleteOrder(orderNumber) {
            if (confirm(`Är du säker på att du vill ta bort beställning ${orderNumber}?`)) {
                localStorage.removeItem(`order_${orderNumber}`);

                // If this was the current order, start a new one
                if (orderState.orderNumber === orderNumber) {
                    startNewOrder();
                }

                // Refresh the orders list
                displayOrders();
                console.log('Deleted order:', orderNumber);
            }
        }

        function startNewOrder() {
            // Clear current order state
            orderState = {
                quantity: 1,
                currentStep: 1,
                formData: {},
                orderNumber: generateUniqueOrderNumber(),
                totalAmount: null,
                sessionId: null
            };

            // Clear form fields
            const fields = ['firstName', 'lastName', 'email', 'phone', 'street', 'postalCode', 'city'];
            fields.forEach(field => {
                const element = document.getElementById(field);
                if (element) element.value = '';
            });

            // Reset country to Sverige
            const countryElement = document.getElementById('country');
            if (countryElement) countryElement.value = 'Sverige';

            // Reset displays
            updateQuantityDisplay();
            updatePricing();
            updateAllDisplays();
            saveSession();

            // Clear URL
            const url = new URL(window.location);
            url.searchParams.delete('order');
            window.history.replaceState({}, '', url);

            closeSettingsModal();
            console.log('Started new order:', orderState.orderNumber);
        }

        function clearAllData() {
            if (confirm('Är du säker på att du vill ta bort ALLA beställningar? Detta kan inte ångras.')) {
                // Remove all order data
                const keysToRemove = [];
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && (key.startsWith('order_') || key === 'lastOrderNumber' || key === 'lastOrder' || key ===
                            'lastEmailData')) {
                        keysToRemove.push(key);
                    }
                }

                keysToRemove.forEach(key => localStorage.removeItem(key));

                // Start fresh
                startNewOrder();
                displayOrders();

                alert('All beställningsdata har raderats.');
            }
        }

        // Settings modal functions
        function openSettingsModal() {
            displayOrders();
            document.getElementById('settingsModal').style.display = 'block';
        }

        function closeSettingsModal() {
            document.getElementById('settingsModal').style.display = 'none';
        }

        // Initialize DOM elements and set up event listeners
        function initializeApp() {
            console.log('Initializing app...');

            // Create or resume session first
            const isResumedSession = createOrResumeSession();

            // Get DOM elements
            quantityDisplay = document.getElementById('quantityDisplay');
            summaryQuantity = document.getElementById('summaryQuantity');
            subtotal = document.getElementById('subtotal');
            shipping = document.getElementById('shipping');
            total = document.getElementById('total');
            errorMessage = document.getElementById('errorMessage');

            // Verify critical elements exist
            if (!quantityDisplay || !summaryQuantity || !subtotal || !shipping || !total) {
                console.error('Critical DOM elements not found');
                return;
            }

            // Add event listeners for buttons
            const decreaseBtn = document.getElementById('decreaseBtn');
            const increaseBtn = document.getElementById('increaseBtn');
            const nextStepBtn = document.getElementById('nextStepBtn');
            const prevStepBtn = document.getElementById('prevStepBtn');
            const prevStepBtn2 = document.getElementById('prevStepBtn2');
            const proceedToEmailBtn = document.getElementById('proceedToEmailBtn');
            const completeOrderBtn = document.getElementById('completeOrderBtn');

            if (decreaseBtn) {
                decreaseBtn.addEventListener('click', () => {
                    console.log('Decrease button clicked');
                    changeQuantity(-1);
                });
            }

            if (increaseBtn) {
                increaseBtn.addEventListener('click', () => {
                    console.log('Increase button clicked');
                    changeQuantity(1);
                });
            }

            if (nextStepBtn) {
                nextStepBtn.addEventListener('click', () => {
                    console.log('Next step button clicked');
                    nextStep();
                });
            }

            if (prevStepBtn) {
                prevStepBtn.addEventListener('click', () => {
                    console.log('Previous step button clicked');
                    prevStep();
                });
            }

            if (prevStepBtn2) {
                prevStepBtn2.addEventListener('click', () => {
                    console.log('Previous step button 2 clicked');
                    prevStep();
                });
            }

            if (proceedToEmailBtn) {
                proceedToEmailBtn.addEventListener('click', () => {
                    console.log('Proceed to email button clicked');
                    nextStep();
                });
            }

            if (completeOrderBtn) {
                completeOrderBtn.addEventListener('click', () => {
                    console.log('Complete order button clicked');
                    if (confirm('Markera beställningen som klar?')) {
                        startNewOrder();
                    }
                });
            }

            // Settings modal event listeners
            const settingsBtn = document.getElementById('settingsBtn');
            const closeSettings = document.getElementById('closeSettings');
            const newOrderBtn = document.getElementById('newOrderBtn');
            const clearDataBtn = document.getElementById('clearDataBtn');
            const settingsModal = document.getElementById('settingsModal');

            if (settingsBtn) {
                settingsBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    openSettingsModal();
                });
            }

            if (closeSettings) {
                closeSettings.addEventListener('click', closeSettingsModal);
            }

            if (newOrderBtn) {
                newOrderBtn.addEventListener('click', startNewOrder);
            }

            if (clearDataBtn) {
                clearDataBtn.addEventListener('click', clearAllData);
            }

            // Close modal when clicking outside
            if (settingsModal) {
                settingsModal.addEventListener('click', (e) => {
                    if (e.target === settingsModal) {
                        closeSettingsModal();
                    }
                });
            }

            // Add clickable step indicators
            document.querySelectorAll('.step.clickable').forEach(step => {
                step.addEventListener('click', () => {
                    const targetStep = parseInt(step.dataset.step);
                    navigateToStep(targetStep);
                });
            });

            // Add email option button listeners
            document.addEventListener('click', (e) => {
                if (e.target.closest('.email-option-btn')) {
                    const service = e.target.closest('.email-option-btn').dataset.service;
                    handleEmailService(service);
                }
            });

            // Mobile menu functionality
            const hamburger = document.querySelector('.hamburger');
            const navMenu = document.querySelector('.nav-menu');

            if (hamburger && navMenu) {
                hamburger.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    navMenu.classList.toggle('active');
                    hamburger.classList.toggle('active');
                });

                document.querySelectorAll('.nav-menu a').forEach(link => {
                    link.addEventListener('click', () => {
                        navMenu.classList.remove('active');
                        hamburger.classList.remove('active');
                    });
                });

                document.addEventListener('click', (e) => {
                    if (!hamburger.contains(e.target) && !navMenu.contains(e.target)) {
                        navMenu.classList.remove('active');
                        hamburger.classList.remove('active');
                    }
                });
            }

            // Initialize display
            updateQuantityDisplay();
            updatePricing();
            updateStepIndicator();

            console.log('App initialized successfully');
        }

        // Step navigation
        function navigateToStep(targetStep) {
            console.log(`Attempting to navigate to step ${targetStep} from step ${orderState.currentStep}`);






            if (targetStep === orderState.currentStep) {
                return; // Already on this step



            }

            // If going forward, validate current step
            if (targetStep > orderState.currentStep && !validateCurrentStep()) {
                showError('Vänligen fyll i alla obligatoriska fält innan du går vidare.');
                setTimeout(hideError, 3000);
                return;
            }

            // Save current step data if going forward
            if (targetStep > orderState.currentStep) {
                saveCurrentStepData();
            }

            orderState.currentStep = targetStep;

            // Handle step-specific actions
            if (orderState.currentStep === 2) {
                if (!orderState.orderNumber) {
                    orderState.orderNumber = generateUniqueOrderNumber();
                }

                const total = (orderState.formData.quantity * BIBLE_PRICE) + SHIPPING_COST;
                orderState.totalAmount = total;

                const orderNumberStep2 = document.getElementById('orderNumberStep2');
                const totalAmountStep2 = document.getElementById('totalAmountStep2');

                if (orderNumberStep2) {
                    orderNumberStep2.textContent = orderState.orderNumber;
                }
                if (totalAmountStep2) {
                    totalAmountStep2.textContent = total;
                }

                saveSession();



                setTimeout(() => {
                    const message = `Bibel beställning ${orderState.orderNumber}`;
                    openSwishPayment(total, message);
                }, 1000);

            } else if (orderState.currentStep === 3) {
                prepareEmailStep();
                saveSession();
            }

            updateStepIndicator();
            showFormSection(orderState.currentStep);
            saveSession();

            document.querySelector('.order-form').scrollIntoView({
                behavior: 'smooth',
                block: 'start'
            });

            console.log(`Successfully navigated to step ${targetStep}`);
        }

        // Quantity management
        function changeQuantity(delta) {
            const newQuantity = Math.max(1, orderState.quantity + delta);
            orderState.quantity = newQuantity;
            updateQuantityDisplay();
            updatePricing();
            saveSession();
        }

        function updateQuantityDisplay() {
            if (quantityDisplay && summaryQuantity) {
                quantityDisplay.textContent = orderState.quantity;
                summaryQuantity.textContent = orderState.quantity;
            }
        }

        function updatePricing() {
            const subtotalAmount = orderState.quantity * BIBLE_PRICE;
            const totalAmount = subtotalAmount + SHIPPING_COST;

            if (subtotal && shipping && total) {
                subtotal.textContent = `${subtotalAmount} kr`;
                shipping.textContent = `${SHIPPING_COST} kr`;
                total.textContent = `${totalAmount} kr`;
            }
        }

        // Step management
        function updateStepIndicator() {
            const steps = document.querySelectorAll('.step');
            steps.forEach((step, index) => {
                const stepNumber = index + 1;
                step.classList.remove('active', 'completed', 'disabled');

                if (stepNumber < orderState.currentStep) {
                    step.classList.add('completed');
                    step.querySelector('.step-number').innerHTML = '<i class="fas fa-check"></i>';
                } else if (stepNumber === orderState.currentStep) {
                    step.classList.add('active');
                    step.querySelector('.step-number').textContent = stepNumber;
                } else {
                    step.querySelector('.step-number').textContent = stepNumber;
                }
            });
        }

        function showFormSection(stepNumber) {
            // Hide all sections
            const sections = document.querySelectorAll('.form-section');
            sections.forEach(section => {
                section.classList.remove('active');
                section.style.display = 'none';
            });

            // Show target section
            const targetSection = document.querySelector(`[data-section="${stepNumber}"]`);
            if (targetSection) {
                targetSection.style.display = 'block';
                setTimeout(() => {
                    targetSection.classList.add('active');
                }, 10);
            }
        }

        function nextStep() {
            navigateToStep(orderState.currentStep + 1);
        }

        function prevStep() {
            if (orderState.currentStep > 1) {
                navigateToStep(orderState.currentStep - 1);
            }
        }

        function prepareEmailStep() {
            const totalAmount = (orderState.formData.quantity * BIBLE_PRICE) + SHIPPING_COST;

            const orderData = {
                orderNumber: orderState.orderNumber,
                timestamp: new Date().toISOString(),
                customer: {
                    fullName: orderState.formData.fullName,
                    firstName: orderState.formData.firstName,
                    lastName: orderState.formData.lastName,
                    email: orderState.formData.email,
                    phone: orderState.formData.phone
                },
                delivery: {
                    street: orderState.formData.street,
                    postalCode: orderState.formData.postalCode,
                    city: orderState.formData.city,
                    country: orderState.formData.country
                },
                items: [{
                    product: 'Svenska Reformationsbibeln',
                    quantity: orderState.formData.quantity,
                    unitPrice: BIBLE_PRICE,
                    subtotal: orderState.formData.quantity * BIBLE_PRICE
                }],
                pricing: {
                    subtotal: orderState.formData.quantity * BIBLE_PRICE,
                    shipping: SHIPPING_COST,
                    total: totalAmount
                }
            };

            const emailData = composeOrderEmail(orderData);
            storedEmailData = emailData;

            const orderNumberStep3 = document.getElementById('orderNumberStep3');
            if (orderNumberStep3) {
                orderNumberStep3.textContent = orderState.orderNumber;
            }

            try {
                localStorage.setItem('lastOrder', JSON.stringify(orderData));
                localStorage.setItem('lastEmailData', JSON.stringify(emailData));
                console.log('Order and email data saved');
            } catch (e) {
                console.log('Could not save to localStorage:', e);
            }
        }

        // Validation
        function validateCurrentStep() {
            console.log('Validating step:', orderState.currentStep);

            switch (orderState.currentStep) {
                case 1:
                    return validateAllFormData();
                case 2:
                    return true;
                case 3:
                    return true;
                default:
                    return false;
            }
        }

        function validateAllFormData() {
            console.log('Validating all form data');

            if (orderState.quantity <= 0) {
                showError('Vänligen välj antal biblar.');
                return false;
            }

            const firstName = document.getElementById('firstName').value.trim();
            const lastName = document.getElementById('lastName').value.trim();
            const email = document.getElementById('email').value.trim();
            const phone = document.getElementById('phone').value.trim();

            if (!firstName || !lastName || !email || !phone) {
                showError('Vänligen fyll i alla obligatoriska kontaktfält.');
                return false;
            }

            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                showError('Vänligen ange en giltig e-postadress.');
                return false;
            }

            const phoneRegex = /^[\d\s\-\+\(\)]+$/;
            if (!phoneRegex.test(phone)) {
                showError('Vänligen ange ett giltigt telefonnummer.');
                return false;
            }

            const street = document.getElementById('street').value.trim();
            const postalCode = document.getElementById('postalCode').value.trim();
            const city = document.getElementById('city').value.trim();

            if (!street || !postalCode || !city) {
                showError('Vänligen fyll i alla obligatoriska adressfält.');
                return false;
            }

            const postalCodeRegex = /^\d{3}\s?\d{2}$/;
            if (!postalCodeRegex.test(postalCode)) {
                showError('Vänligen ange ett giltigt postnummer (t.ex. 123 45).');
                return false;
            }

            console.log('All validation passed');
            return true;
        }

        function saveCurrentStepData() {
            console.log('Saving data for step:', orderState.currentStep);

            if (orderState.currentStep === 1) {
                orderState.formData.quantity = orderState.quantity;
                orderState.formData.firstName = document.getElementById('firstName').value.trim();
                orderState.formData.lastName = document.getElementById('lastName').value.trim();
                orderState.formData.fullName = `${orderState.formData.firstName} ${orderState.formData.lastName}`;
                orderState.formData.email = document.getElementById('email').value.trim();
                orderState.formData.phone = document.getElementById('phone').value.trim();
                orderState.formData.street = document.getElementById('street').value.trim();
                orderState.formData.postalCode = document.getElementById('postalCode').value.trim();
                orderState.formData.city = document.getElementById('city').value.trim();
                orderState.formData.country = document.getElementById('country').value;

                console.log('Saved all form data:', orderState.formData);
            }
        }

        // MINIMIZED EMAIL COMPOSITION
        function composeOrderEmail(orderData) {
            const orderNumber = orderData.orderNumber;
            const totalAmount = orderData.pricing.total;

            const subject = `Beställning ${orderNumber}`;

            const emailBody = `Beställning: ${orderNumber}
Datum: ${new Date().toLocaleDateString('sv-SE')}

Kund: ${orderData.customer.fullName}
E-post: ${orderData.customer.email}
Telefon: ${orderData.customer.phone}

Adress:
${orderData.delivery.street}
${orderData.delivery.postalCode} ${orderData.delivery.city}
${orderData.delivery.country}

Beställning: ${orderData.items[0].quantity} x Svenska Reformationsbibeln
Totalt: ${totalAmount} kr (inkl frakt)

Swish-betalning genomförd till: ${orderData.customer.phone}`;

            return {
                subject,
                emailBody
            };
        }

        // Email service handler
        function handleEmailService(service) {
            if (!storedEmailData) {
                alert('Ingen beställningsdata hittades.');
                return;
            }

            const subject = encodeURIComponent(storedEmailData.subject);
            const body = encodeURIComponent(storedEmailData.emailBody);
            const recipient = 'post@bibel.se';

            switch (service) {
                case 'gmail':
                    window.open(`https://mail.google.com/mail/?view=cm&fs=1&to=${recipient}&su=${subject}&body=${body}`,
                        '_blank');
                    break;

                case 'outlook':
                    window.open(
                        `https://outlook.live.com/mail/0/deeplink/compose?to=${recipient}&subject=${subject}&body=${body}`,
                        '_blank');
                    break;

                case 'yahoo':
                    window.open(`https://compose.mail.yahoo.com/?to=${recipient}&subject=${subject}&body=${body}`,
                        '_blank');
                    break;

                case 'apple':
                    window.location.href = `mailto:${recipient}?subject=${subject}&body=${body}`;
                    break;

                case 'default':
                    window.location.href = `mailto:${recipient}?subject=${subject}&body=${body}`;
                    break;

                case 'copy':
                    copyToClipboard(`Till: ${recipient}
Ämne: ${storedEmailData.subject}

${storedEmailData.emailBody}`);
                    break;
            }
        }

        // Copy to clipboard function
        function copyToClipboard(text) {
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text).then(() => {
                    showCopySuccess();
                }).catch(() => {
                    fallbackCopyToClipboard(text);
                });
            } else {
                fallbackCopyToClipboard(text);
            }
        }

        function fallbackCopyToClipboard(text) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.left = '-999999px';
            textArea.style.top = '-999999px';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();

            try {
                document.execCommand('copy');
                showCopySuccess();
            } catch (err) {
                alert('Kunde inte kopiera automatiskt. Markera och kopiera texten manuellt.');
            }

            document.body.removeChild(textArea);
        }

        function showCopySuccess() {
            const copyBtn = document.querySelector('[data-service="copy"]');
            if (copyBtn) {
                copyBtn.classList.add('copy-success');
                copyBtn.innerHTML = '<i class="fas fa-check" style="color: #28a745;"></i><span>Kopierat!</span>';

                setTimeout(() => {
                    copyBtn.classList.remove('copy-success');
                    copyBtn.innerHTML =
                        '<i class="fas fa-copy" style="color: #28a745;"></i><span>Kopiera</span>';
                }, 2000);
            }

            alert('E-postinnehåll kopierat! Klistra in i din e-postklient och skicka till post@bibel.se');
        }

        // Swish payment integration
        function openSwishPayment(amount, message) {
            console.log('Opening Swish payment for:', amount, 'kr');

            const swishData = {
                "version": 1,
                "payee": {
                    "value": "1233882669",
                    "editable": false
                },
                "amount": {
                    "value": amount,
                    "editable": false
                },
                "message": {
                    "value": message,
                    "editable": false
                }
            };

            const jsonUrl = `swish://payment?data=${encodeURIComponent(JSON.stringify(swishData))}`;

            try {
                window.location.href = jsonUrl;
                console.log('Swish opened with JSON format');
                return;
            } catch (error) {
                console.log('JSON format failed:', error);
            }

            const fallbackUrls = [
                `swish://payment?phone=1233882669&amount=${amount}&message=${encodeURIComponent(message)}`,
                `swish://paymentrequest?phone=1233882669&amount=${amount}&message=${encodeURIComponent(message)}`,
                `swish://payment?phone=1233882669&amount=${amount}`,
                `swish://payment?phone=1233882669`
            ];

            for (let url of fallbackUrls) {
                try {
                    window.location.href = url;
                    return;
                } catch (error) {
                    console.log('Fallback failed:', error);
                }
            }

            try {
                window.location.href = "swish://";
            } catch (error) {
                console.log('Could not open Swish app');
                alert('Kunde inte öppna Swish. Kontrollera att Swish-appen är installerad.');
            }
        }

        // Error handling
        function showError(message) {
            if (errorMessage) {
                errorMessage.textContent = message;
                errorMessage.style.display = 'block';
                errorMessage.scrollIntoView({
                    behavior: 'smooth',
                    block: 'nearest'
                });
            }
        }

        function hideError() {
            if (errorMessage) {
                errorMessage.style.display = 'none';
            }
        }

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', function () {
            initializeApp();
        });

        // Global functions for order management (called from HTML)
        window.resumeOrder = resumeOrder;
        window.duplicateOrder = duplicateOrder;
        window.deleteOrder = deleteOrder;
    </script>
</body>

</html>