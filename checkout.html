<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=3.0, user-scalable=yes">
    
    <link rel="icon" type="image/png" href="favicon/favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/svg+xml" href="favicon/favicon.svg" />
    <link rel="shortcut icon" href="favicon/favicon.ico" />
    <link rel="apple-touch-icon" sizes="180x180" href="favicon/apple-touch-icon.png" />

    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="checkout.css">
    <title>Svenska Reformationsbibeln - Beställning</title>
    <link href="https://fonts.googleapis.com/css2?family=EB+Garamond:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- QR Code Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
</head>

<body>
    <header class="header">
        <nav class="nav-container">
            <div class="logo">
                <a href="index.html">
                    <div class="logo-icon"></div>
                </a>
            </div>
            <ul class="nav-menu">
                <li><a href="index.html">Hem</a></li>
                <li><a href="QnA.html">Frågor & svar</a></li>
                <li><a href="index.html#resurser">Resurser</a></li>
                <li><a href="https://bibel.se" target="_blank">Bibel.se</a></li>
                <li><a href="index.html#kontakt">Kontakt</a></li>
                <li><a href="#" id="settingsBtn"><i class="fas fa-cog"></i> Inställningar</a></li>
            </ul>
            <div class="hamburger">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </nav>
    </header>

    <div class="order-container">

        <div class="step-indicator">
            <div class="step active clickable" data-step="1">
                <div class="step-number">1</div>
                <span>Formulär</span>
            </div>
            <div class="step clickable" data-step="2">
                <div class="step-number">2</div>
                <span>Swish (Betala)</span>
            </div>
            <div class="step clickable" data-step="3">
                <div class="step-number">3</div>
                <span>Skicka info via e-post</span>
            </div>
        </div>

        <div class="order-form">
            <div class="error-message" id="errorMessage"></div>

            <!-- Step 1 -->
            <div class="form-section active" data-section="1">
                <h2><i class="fas fa-shopping-cart"></i> Beställningsuppgifter</h2>

                <div style="background: rgba(139, 105, 20, 0.05); border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem; border: 1px solid var(--border-color);">
                    <h3 style="color: var(--primary-text); margin-bottom: 1rem; font-size: 1.3rem;">
                        <i class="fas fa-book"></i> Välj antal
                    </h3>

                    <div class="info-box">
                        <p><strong>Endast förskottsbetalning</strong> – För att förenkla administration så återgår vi till förskottsinbetalning.</p>
                    </div>
                    <div class="info-box">
                        <p><strong>Svenska Reformationsbibeln</strong> - En modern översättning av Karl XII:s Bibel från 1703, baserad på Textus Receptus. <strong> Pris: 200 kr per exemplar + frakt.</strong></p>
                    </div>

                    <div class="quantity-selector">
                        <button type="button" class="quantity-btn" id="decreaseBtn" style="width: 60px; height: 60px; font-size: 2rem;">−</button>
                        <input type="number" class="quantity-display" id="quantityDisplay" value="1" min="1" style="text-align: center; -moz-appearance: textfield;">
                        <button type="button" class="quantity-btn" id="increaseBtn" style="width: 60px; height: 60px; font-size: 2rem;">+</button>
                    </div>

                    <div class="price-summary">
                        <div class="price-line">
                            <span>Biblar (<span id="summaryQuantity">1</span> st):</span>
                            <span id="subtotal">200 kr</span>
                        </div>
                        <div class="price-line">
                            <span>Frakt:</span>
                            <span id="shipping">49 kr</span>
                        </div>
                        <div class="price-line total">
                            <span>Totalt:</span>
                            <span id="total">249 kr</span>
                        </div>
                    </div>
                </div>

                <div style="background: rgba(139, 105, 20, 0.05); border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem; border: 1px solid var(--border-color);">
                    <h3 style="color: var(--primary-text); margin-bottom: 1rem; font-size: 1.3rem;">
                        <i class="fas fa-user"></i> Kontaktuppgifter
                    </h3>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group required">
                            <label for="firstName">Förnamn</label>
                            <input type="text" id="firstName" name="given-name" autocomplete="given-name" required>
                        </div>
                        <div class="form-group required">
                            <label for="lastName">Efternamn</label>
                            <input type="text" id="lastName" name="family-name" autocomplete="family-name" required>
                        </div>
                    </div>

                    <div class="form-group required">
                        <label for="email">E-postadress</label>
                        <input type="email" id="email" name="email" autocomplete="email" required>
                    </div>

                    <div class="form-group required">
                        <label for="phone">Telefonnummer (för Swish-betalning)</label>
                        <input type="tel" id="phone" name="tel" autocomplete="tel" placeholder="070-123 45 67" required>
                    </div>
                </div>

                <div style="background: rgba(139, 105, 20, 0.05); border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem; border: 1px solid var(--border-color);">
                    <h3 style="color: var(--primary-text); margin-bottom: 1rem; font-size: 1.3rem;">
                        <i class="fas fa-truck"></i> Leveransadress
                    </h3>

                    <div class="form-group required">
                        <label for="street">Gatuadress</label>
                        <input type="text" id="street" name="address-line1" autocomplete="address-line1" placeholder="Gatunamn och nummer" required>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 1rem;">
                        <div class="form-group required">
                            <label for="postalCode">Postnummer</label>
                            <input type="text" id="postalCode" name="postal-code" autocomplete="postal-code" placeholder="123 45" pattern="[0-9]{3}\s?[0-9]{2}" required>
                        </div>
                        <div class="form-group required">
                            <label for="city">Ort</label>
                            <input type="text" id="city" name="address-level2" autocomplete="address-level2" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="country">Land</label>
                        <select id="country" name="country" autocomplete="country">
                            <option value="Sverige" selected>Sverige</option>
                            <option value="Norge">Norge</option>
                            <option value="Danmark">Danmark</option>
                            <option value="Finland">Finland</option>
                            <option value="Island">Island</option>
                        </select>
                    </div>
                </div>

                <div class="btn-group">
                    <div></div>
                    <button type="button" class="btn btn-primary" id="nextStepBtn">
                        Nästa steg <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
            </div>

<!-- Step 2 -->
<div class="form-section" data-section="2">
    <div style="background: rgba(212, 175, 55, 0.05); border: 2px solid var(--primary-gold); border-radius: 12px; padding: 2rem; margin: 2rem auto; max-width: 600px;">
        <div style="text-align: center;">
            <i class="fas fa-mobile-alt" style="font-size: 4rem; color: #2d5f3f; margin-bottom: 1.5rem;"></i>
            <h2 style="font-size: 2rem; margin-bottom: 1rem;">Betala med Swish</h2>
            <p style="font-size: 1.3rem; margin-bottom: 1.5rem;">Skanna QR-koden för att betala</p>
            
<!-- QR Code with Swish background -->
<div id="qrCodeContainer" style="position: relative; display: inline-block; margin: 20px 0; margin-top:2rem;">
    <img src="img/swish_clean_01.png" alt="Swish" style="margin-top:5.4rem; margin-right:1.75rem; display: block; width: 340px; height: auto; border-radius: 12px;">
    <canvas id="swishQRCode" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); display: block;"></canvas>
</div>
            
            <div style="background: rgba(46, 125, 50, 0.1); border: 2px solid #2d5f3f; border-radius: 12px; padding: 1.5rem; margin-top: 1.5rem;">
                <!-- <p style="font-size: 1.1rem; margin: 0;"><strong>Ordernummer:</strong> <span id="orderNumberStep2"></span></p>-->
                <p style="font-size: 1.1rem; margin: 0.5rem 0 0 0;"><strong>Belopp:</strong> <span id="totalAmountStep2"></span> kr</p>
                <p style="font-size: 1.1rem; margin: 0.5rem 0 0 0;"><strong>Meddelande:</strong> <span id="swishMessageDisplay"></span></p>
            </div>
            
            <button id="openSwishAppBtn" style="margin-top: 1.5rem; width: 100%; padding: 15px; background: #2d5f3f; color: white; border: none; border-radius: 8px; font-size: 1.1rem; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px;">
                <i class="fas fa-mobile-alt"></i>
                Öppna Swish
            </button>
        </div>
    </div>
    
    <div class="btn-group" style="margin-top: 2rem;">
        <button type="button" class="btn btn-secondary" id="prevStepBtn">
            <i class="fas fa-arrow-left"></i> Tillbaka
        </button>
        <button type="button" class="btn btn-primary" id="proceedToEmailBtn">
            Betalning klar - Nästa steg <i class="fas fa-arrow-right"></i>
        </button>
    </div>
</div>

            <!-- Step 3 -->
            <div class="form-section" data-section="3">
                <div style="text-align: center; padding: 2rem;">
                    <i class="fas fa-envelope" style="font-size: 4rem; color: #d4af37; margin-bottom: 1.5rem;"></i>
                    <h2 style="font-size: 2rem; margin-bottom: 1rem;">Skicka orderbekräftelse</h2>
                    <p style="font-size: 1.3rem; margin-bottom: 1.8rem;">Välj hur du vill skicka beställningen till oss.<br> Dubbelkolla i "skickade mail" så att ordern säkert har gått iväg.</p>

                    <div style="background: rgba(139, 105, 20, 0.1); border: 2px solid var(--primary-gold); border-radius: 12px; padding: 1.5rem; margin: 1.5rem auto; max-width: 500px;">
                        <p style="font-size: 1.2rem; margin: 0;"><strong>Ordernummer:</strong> <span id="orderNumberStep3"></span></p>
                        <p style="font-size: 1.3rem; margin: 0.5rem 0 0 0;"> <strong> Till: </strong> post@bibel.se </p>
                    </div>

                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin: 2rem 0; max-width: 600px; margin-left: auto; margin-right: auto;">
                        <button class="email-option-btn email-option-recommended" data-service="default">
                            <span class="recommended-badge">Rekommenderat</span>
                            <i class="fas fa-envelope" style="color: #d4af37;"></i>
                            <span>E-postapp (Mejlprogram)</span>
                        </button>
                        <button class="email-option-btn" data-service="gmail">
                            <i class="fab fa-google" style="color: #EA4335;"></i>
                            <span>Gmail</span>
                        </button>
                        <button class="email-option-btn" data-service="outlook">
                            <i class="fab fa-microsoft" style="color: #0078D4;"></i>
                            <span>Outlook</span>
                        </button>
                        <button class="email-option-btn" data-service="copy">
                            <i class="fas fa-copy" style="color: #28a745;"></i>
                            <span>Kopiera</span>
                        </button>
                    </div>
                    
                    <div class="btn-group" style="margin-top: 2rem;">
                        <button type="button" class="btn btn-secondary" id="prevStepBtn2">
                            <i class="fas fa-arrow-left"></i> Tillbaka
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-cog"></i> Beställningsinställningar</h2>
                <span class="close" id="closeSettings">&times;</span>
            </div>
            <div class="modal-body">
                <div class="settings-section">
                    <h3><i class="fas fa-history"></i> Tidigare beställningar</h3>
                    <div id="ordersList" class="orders-list"></div>
                </div>
                <div class="settings-section">
                    <h3><i class="fas fa-tools"></i> Åtgärder</h3>
                    <div class="settings-actions">
                        <button class="btn btn-secondary" id="newOrderBtn">
                            <i class="fas fa-plus"></i> Ny beställning
                        </button>
                        <button class="btn btn-warning" id="clearDataBtn">
                            <i class="fas fa-trash"></i> Rensa all data
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <style>
        #swishQRCode { border-radius: 8px; }
        #openSwishAppBtn:hover {
            background: #1e4029;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(45, 95, 63, 0.3);
            transition: all 0.2s;
        }
        #openSwishAppBtn:active { transform: translateY(0); }
        @media (min-width: 768px) {
            #openSwishAppBtn { display: none !important; }
        }
    </style>

    <script>
        let orderState = {
            quantity: 1,
            currentStep: 1,
            formData: {},
            orderNumber: null,
            totalAmount: null,
            sessionId: null
        };

        const BIBLE_PRICE = 200;
        const SHIPPING_COST = 49;
        let storedEmailData = null;
        let quantityDisplay, summaryQuantity, subtotal, shipping, total, errorMessage;

function generateUniqueOrderNumber() {
    const now = new Date();
    const datePart = now.toISOString().slice(2, 10).replace(/-/g, '');
    const randomPart = Math.random().toString(36).substring(2, 6).toUpperCase();
    
    return `SRB-${datePart}-${randomPart}`;
}

function generateSwishQRCode(amount, message, payeeNumber = "1233882669") {
    const formattedAmount = parseFloat(amount).toFixed(2).replace('.', ',');
    const encodedMessage = encodeURIComponent(message);
    const swishData = `C${payeeNumber};${formattedAmount};${encodedMessage};0`;
    
    console.log('Generating Swish QR:', swishData);
    
    try {
        const canvas = document.getElementById('swishQRCode');
        if (!canvas) {
            console.error('QR canvas not found');
            return null;
        }
        
        const qr = new QRious({
            element: canvas,
            value: swishData,
            size: 250,  // Smaller size to fit in the Swish logo
            level: 'M',
            foreground: '#000000',
            background: 'transparent',  // Transparent background
            padding: 0
        });
        
        console.log('QR generated successfully');
        return qr;
    } catch (error) {
        console.error('QR generation error:', error);
        return null;
    }
}
function openSwishApp() {
    if (!orderState.orderNumber || !orderState.totalAmount) {
        alert('Beställningsdata saknas');
        return;
    }
    
    const amount = orderState.totalAmount;
    const message = `Bibel ${orderState.quantity}st ${orderState.orderNumber}`;
    const payeeNumber = "1233882669";
    
    // Try the standard payment format first
    const swishUrl = `swish://payment?data=${encodeURIComponent(JSON.stringify({
        version: 1,
        payee: {
            value: payeeNumber,
            editable: false
        },
        amount: {
            value: amount,
            editable: false
        },
        message: {
            value: message,
            editable: false
        }
    }))}`;
    
    console.log('Opening Swish app:', swishUrl);
    window.location.href = swishUrl;
}
        function createOrResumeSession() {
            const urlParams = new URLSearchParams(window.location.search);
            const urlOrderNumber = urlParams.get('order');
            let existingSession = null;
            
            if (urlOrderNumber) {
                existingSession = loadSessionByOrderNumber(urlOrderNumber);
            } else {
                existingSession = loadLastSession();
            }

            if (existingSession) {
                console.log('Resuming session:', existingSession.orderNumber);
                orderState = { ...orderState, ...existingSession };
                restoreFormFromSession();
                updateAllDisplays();
                return true;
            } else {
                const newOrderNumber = generateUniqueOrderNumber();
                orderState.orderNumber = newOrderNumber;
                orderState.sessionId = newOrderNumber;
                console.log('New session:', newOrderNumber);
                saveSession();
                return false;
            }
        }

        function saveSession() {
            const sessionData = {
                ...orderState,
                timestamp: new Date().toISOString(),
                lastActivity: Date.now()
            };

            try {
                localStorage.setItem(`order_${orderState.orderNumber}`, JSON.stringify(sessionData));
                localStorage.setItem('lastOrderNumber', orderState.orderNumber);
                const url = new URL(window.location);
                url.searchParams.set('order', orderState.orderNumber);
                window.history.replaceState({}, '', url);
            } catch (e) {
                console.error('Save session failed:', e);
            }
        }

        function loadSessionByOrderNumber(orderNumber) {
            try {
                const sessionData = localStorage.getItem(`order_${orderNumber}`);
                return sessionData ? JSON.parse(sessionData) : null;
            } catch (e) {
                return null;
            }
        }

        function loadLastSession() {
            try {
                const lastOrderNumber = localStorage.getItem('lastOrderNumber');
                return lastOrderNumber ? loadSessionByOrderNumber(lastOrderNumber) : null;
            } catch (e) {
                return null;
            }
        }

        function restoreFormFromSession() {
            if (orderState.formData && Object.keys(orderState.formData).length > 0) {
                const fields = ['firstName', 'lastName', 'email', 'phone', 'street', 'postalCode', 'city', 'country'];
                fields.forEach(field => {
                    const element = document.getElementById(field);
                    if (element && orderState.formData[field]) {
                        element.value = orderState.formData[field];
                    }
                });
                if (orderState.quantity) {
                    updateQuantityDisplay();
                    updatePricing();
                }
            }
        }
            function updateAllDisplays() {
                updateStepIndicator();
                showFormSection(orderState.currentStep);
                
                ['orderNumberStep2', 'orderNumberStep3'].forEach(id => {
                    const element = document.getElementById(id);
                    if (element && orderState.orderNumber) {
                        element.textContent = orderState.orderNumber;
                    }
                });

                if (orderState.totalAmount) {
                    const totalElement = document.getElementById('totalAmountStep2');
                    if (totalElement) totalElement.textContent = orderState.totalAmount;
                }

                if (orderState.currentStep === 2 && orderState.orderNumber && orderState.totalAmount) {
                    setTimeout(() => {
                        const message = `Bibel ${orderState.quantity}st ${orderState.orderNumber}`;
                        generateSwishQRCode(orderState.totalAmount, message);
                        const msgDisplay = document.getElementById('swishMessageDisplay');
                        if (msgDisplay) msgDisplay.textContent = message;
                    }, 200);
                }

                if (orderState.currentStep === 3 && !storedEmailData) {
                    prepareEmailStep();
                }
            }
        function getAllOrders() {
            const orders = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('order_')) {
                    try {
                        orders.push(JSON.parse(localStorage.getItem(key)));
                    } catch (e) {}
                }
            }
            return orders.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        }

        function displayOrders() {
            const ordersList = document.getElementById('ordersList');
            const orders = getAllOrders();

            if (orders.length === 0) {
                ordersList.innerHTML = '<div class="empty-state"><i class="fas fa-shopping-cart"></i><p>Inga tidigare beställningar hittades.</p></div>';
                return;
            }

            ordersList.innerHTML = orders.map(order => {
                const date = new Date(order.timestamp).toLocaleDateString('sv-SE');
                const time = new Date(order.timestamp).toLocaleTimeString('sv-SE', { hour: '2-digit', minute: '2-digit' });
                const stepText = ['Formulär', 'Swish (Betala)', 'Skicka info via e-post'][order.currentStep - 1] || 'Okänt';
                const statusClass = `status-step${order.currentStep}`;

                return `
                    <div class="order-card">
                        <div class="order-header">
                            <div class="order-number">${order.orderNumber}</div>
                            <div class="order-date">${date} ${time}</div>
                        </div>
                        <div class="order-details">
                            <div><strong>Kund:</strong> ${order.formData?.fullName || 'Ej angivet'}</div>
                            <div><strong>Antal:</strong> ${order.quantity || 1} st</div>
                            <div><strong>E-post:</strong> ${order.formData?.email || 'Ej angivet'}</div>
                            <div><strong>Totalt:</strong> ${((order.quantity || 1) * BIBLE_PRICE) + SHIPPING_COST} kr</div>
                        </div>
                        <div style="margin: 1rem 0;">
                            <span class="order-status ${statusClass}">Steg ${order.currentStep}: ${stepText}</span>
                        </div>
                        <div class="order-actions">
                            <button class="btn btn-primary btn-small" onclick="resumeOrder('${order.orderNumber}')"><i class="fas fa-play"></i> Fortsätt</button>
                            <button class="btn btn-secondary btn-small" onclick="duplicateOrder('${order.orderNumber}')"><i class="fas fa-copy"></i> Kopiera</button>
                            <button class="btn btn-warning btn-small" onclick="deleteOrder('${order.orderNumber}')"><i class="fas fa-trash"></i> Ta bort</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function resumeOrder(orderNumber) {
            const orderData = loadSessionByOrderNumber(orderNumber);
            if (orderData) {
                orderState = { ...orderState, ...orderData };
                restoreFormFromSession();
                updateAllDisplays();
                closeSettingsModal();
                const url = new URL(window.location);
                url.searchParams.set('order', orderNumber);
                window.history.replaceState({}, '', url);
            }
        }

        function duplicateOrder(orderNumber) {
            const orderData = loadSessionByOrderNumber(orderNumber);
            if (orderData) {
                const newOrderNumber = generateUniqueOrderNumber();
                orderState = {
                    ...orderData,
                    orderNumber: newOrderNumber,
                    sessionId: newOrderNumber,
                    currentStep: 1,
                    timestamp: new Date().toISOString(),
                    lastActivity: Date.now()
                };
                restoreFormFromSession();
                updateAllDisplays();
                saveSession();
                closeSettingsModal();
            }
        }

        function deleteOrder(orderNumber) {
            if (confirm(`Är du säker på att du vill ta bort beställning ${orderNumber}?`)) {
                localStorage.removeItem(`order_${orderNumber}`);
                if (orderState.orderNumber === orderNumber) startNewOrder();
                displayOrders();
            }
        }

        function startNewOrder() {
            orderState = {
                quantity: 1,
                currentStep: 1,
                formData: {},
                orderNumber: generateUniqueOrderNumber(),
                totalAmount: null,
                sessionId: null
            };

            ['firstName', 'lastName', 'email', 'phone', 'street', 'postalCode', 'city'].forEach(field => {
                const element = document.getElementById(field);
                if (element) element.value = '';
            });

            const countryElement = document.getElementById('country');
            if (countryElement) countryElement.value = 'Sverige';

            updateQuantityDisplay();
            updatePricing();
            updateAllDisplays();
            saveSession();

            const url = new URL(window.location);
            url.searchParams.delete('order');
            window.history.replaceState({}, '', url);
            closeSettingsModal();
        }

        function clearAllData() {
            if (confirm('Är du säker på att du vill ta bort ALLA beställningar? Detta kan inte ångras.')) {
                const keysToRemove = [];
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && (key.startsWith('order_') || key === 'lastOrderNumber' || key === 'lastOrder' || key === 'lastEmailData')) {
                        keysToRemove.push(key);
                    }
                }
                keysToRemove.forEach(key => localStorage.removeItem(key));
                startNewOrder();
                displayOrders();
                alert('All beställningsdata har raderats.');
            }
        }

        function openSettingsModal() {
            displayOrders();
            document.getElementById('settingsModal').style.display = 'block';
        }

        function closeSettingsModal() {
            document.getElementById('settingsModal').style.display = 'none';
        }

        function initializeApp() {
            console.log('Initializing...');
            createOrResumeSession();

            quantityDisplay = document.getElementById('quantityDisplay');
            summaryQuantity = document.getElementById('summaryQuantity');
            subtotal = document.getElementById('subtotal');
            shipping = document.getElementById('shipping');

            

            total = document.getElementById('total');
            errorMessage = document.getElementById('errorMessage');

            if (!quantityDisplay || !summaryQuantity || !subtotal || !shipping || !total) {
                console.error('Critical DOM elements not found');
                return;
            }

            const decreaseBtn = document.getElementById('decreaseBtn');
            const increaseBtn = document.getElementById('increaseBtn');
            const nextStepBtn = document.getElementById('nextStepBtn');
            const prevStepBtn = document.getElementById('prevStepBtn');
            const prevStepBtn2 = document.getElementById('prevStepBtn2');
            const proceedToEmailBtn = document.getElementById('proceedToEmailBtn');
            const openSwishAppBtn = document.getElementById('openSwishAppBtn');

            if (decreaseBtn) decreaseBtn.addEventListener('click', () => changeQuantity(-1));
            if (increaseBtn) increaseBtn.addEventListener('click', () => changeQuantity(1));
            if (nextStepBtn) nextStepBtn.addEventListener('click', nextStep);
            if (prevStepBtn) prevStepBtn.addEventListener('click', prevStep);
            if (prevStepBtn2) prevStepBtn2.addEventListener('click', prevStep);
            if (proceedToEmailBtn) proceedToEmailBtn.addEventListener('click', nextStep);
            if (openSwishAppBtn) openSwishAppBtn.addEventListener('click', openSwishApp);

            const settingsBtn = document.getElementById('settingsBtn');
            const closeSettings = document.getElementById('closeSettings');
            const newOrderBtn = document.getElementById('newOrderBtn');
            const clearDataBtn = document.getElementById('clearDataBtn');
            const settingsModal = document.getElementById('settingsModal');

            if (settingsBtn) settingsBtn.addEventListener('click', (e) => { e.preventDefault(); openSettingsModal(); });
            if (closeSettings) closeSettings.addEventListener('click', closeSettingsModal);
            if (newOrderBtn) newOrderBtn.addEventListener('click', startNewOrder);
            if (clearDataBtn) clearDataBtn.addEventListener('click', clearAllData);
            if (settingsModal) settingsModal.addEventListener('click', (e) => { if (e.target === settingsModal) closeSettingsModal(); });

            document.querySelectorAll('.step.clickable').forEach(step => {
                step.addEventListener('click', () => navigateToStep(parseInt(step.dataset.step)));
            });

            document.addEventListener('click', (e) => {
                if (e.target.closest('.email-option-btn')) {
                    handleEmailService(e.target.closest('.email-option-btn').dataset.service);
                }
            });

            const hamburger = document.querySelector('.hamburger');
            const navMenu = document.querySelector('.nav-menu');

            if (hamburger && navMenu) {
                hamburger.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    navMenu.classList.toggle('active');
                    hamburger.classList.toggle('active');
                });

                document.querySelectorAll('.nav-menu a').forEach(link => {
                    link.addEventListener('click', () => {
                        navMenu.classList.remove('active');
                        hamburger.classList.remove('active');
                    });
                });

                document.addEventListener('click', (e) => {
                    if (!hamburger.contains(e.target) && !navMenu.contains(e.target)) {
                        navMenu.classList.remove('active');
                        hamburger.classList.remove('active');
                    }
                });
            }

            // Add this event listener in your initializeApp() function
if (quantityDisplay) {
    quantityDisplay.addEventListener('input', (e) => {
        let value = parseInt(e.target.value) || 1;
        value = Math.max(1, value);
        orderState.quantity = value;
        updateQuantityDisplay();
        updatePricing();
        saveSession();
    });
}


            updateQuantityDisplay();
            updatePricing();
            updateStepIndicator();
            console.log('App initialized');
        }

        function navigateToStep(targetStep) {
            if (targetStep === orderState.currentStep) return;

            if (targetStep > orderState.currentStep && !validateCurrentStep()) {
                showError('Vänligen fyll i alla obligatoriska fält innan du går vidare.');
                setTimeout(hideError, 3000);
                return;
            }

            if (targetStep > orderState.currentStep) saveCurrentStepData();

            orderState.currentStep = targetStep;

if (orderState.currentStep === 2) {
    if (!orderState.orderNumber) orderState.orderNumber = generateUniqueOrderNumber();

    const total = (orderState.formData.quantity * BIBLE_PRICE) + SHIPPING_COST;
    orderState.totalAmount = total;
    const message = `Bibel ${orderState.quantity}st ${orderState.orderNumber}`;


    const orderNumberStep2 = document.getElementById('orderNumberStep2');
    const totalAmountStep2 = document.getElementById('totalAmountStep2');
    const swishMessageDisplay = document.getElementById('swishMessageDisplay');

    if (orderNumberStep2) orderNumberStep2.textContent = orderState.orderNumber;
    if (totalAmountStep2) totalAmountStep2.textContent = total;
    if (swishMessageDisplay) swishMessageDisplay.textContent = message;

    saveSession();
    setTimeout(() => generateSwishQRCode(total, message), 100);

            } else if (orderState.currentStep === 3) {
                prepareEmailStep();
                saveSession();
            }

            updateStepIndicator();
            showFormSection(orderState.currentStep);
            saveSession();
            document.querySelector('.order-form').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

// Update the changeQuantity function
function changeQuantity(delta) {
    orderState.quantity = Math.max(1, orderState.quantity + delta);
    updateQuantityDisplay();
    updatePricing();
    saveSession();
}

// Update the updateQuantityDisplay function
function updateQuantityDisplay() {
    if (quantityDisplay && summaryQuantity) {
        quantityDisplay.value = orderState.quantity;
        summaryQuantity.textContent = orderState.quantity;
    }
}

        function updatePricing() {
            const subtotalAmount = orderState.quantity * BIBLE_PRICE;
            const totalAmount = subtotalAmount + SHIPPING_COST;

            if (subtotal && shipping && total) {
                subtotal.textContent = `${subtotalAmount} kr`;
                shipping.textContent = `${SHIPPING_COST} kr`;
                total.textContent = `${totalAmount} kr`;
            }
        }

        function updateStepIndicator() {
            document.querySelectorAll('.step').forEach((step, index) => {
                const stepNumber = index + 1;
                step.classList.remove('active', 'completed', 'disabled');

                if (stepNumber < orderState.currentStep) {
                    step.classList.add('completed');
                    step.querySelector('.step-number').innerHTML = '<i class="fas fa-check"></i>';
                } else if (stepNumber === orderState.currentStep) {
                    step.classList.add('active');
                    step.querySelector('.step-number').textContent = stepNumber;
                } else {
                    step.querySelector('.step-number').textContent = stepNumber;
                }
            });
        }

        function showFormSection(stepNumber) {
            document.querySelectorAll('.form-section').forEach(section => {
                section.classList.remove('active');
                section.style.display = 'none';
            });

            const targetSection = document.querySelector(`[data-section="${stepNumber}"]`);
            if (targetSection) {
                targetSection.style.display = 'block';
                setTimeout(() => targetSection.classList.add('active'), 10);
            }
        }

        function nextStep() {
            navigateToStep(orderState.currentStep + 1);
        }

        function prevStep() {
            if (orderState.currentStep > 1) navigateToStep(orderState.currentStep - 1);
        }

        function prepareEmailStep() {
            const totalAmount = (orderState.formData.quantity * BIBLE_PRICE) + SHIPPING_COST;

            const orderData = {
                orderNumber: orderState.orderNumber,
                timestamp: new Date().toISOString(),
                customer: {
                    fullName: orderState.formData.fullName,
                    firstName: orderState.formData.firstName,
                    lastName: orderState.formData.lastName,
                    email: orderState.formData.email,
                    phone: orderState.formData.phone
                },
                delivery: {
                    street: orderState.formData.street,
                    postalCode: orderState.formData.postalCode,
                    city: orderState.formData.city,
                    country: orderState.formData.country
                },
                items: [{
                    product: 'Svenska Reformationsbibeln',
                    quantity: orderState.formData.quantity,
                    unitPrice: BIBLE_PRICE,
                    subtotal: orderState.formData.quantity * BIBLE_PRICE
                }],
                pricing: {
                    subtotal: orderState.formData.quantity * BIBLE_PRICE,
                    shipping: SHIPPING_COST,
                    total: totalAmount
                }
            };

            const emailData = composeOrderEmail(orderData);
            storedEmailData = emailData;

            const orderNumberStep3 = document.getElementById('orderNumberStep3');
            if (orderNumberStep3) orderNumberStep3.textContent = orderState.orderNumber;

            try {
                localStorage.setItem('lastOrder', JSON.stringify(orderData));
                localStorage.setItem('lastEmailData', JSON.stringify(emailData));
            } catch (e) {}
        }

        function validateCurrentStep() {
            return orderState.currentStep === 1 ? validateAllFormData() : true;
        }

        function validateAllFormData() {
            if (orderState.quantity <= 0) {
                showError('Vänligen välj antal biblar.');
                return false;
            }

            const firstName = document.getElementById('firstName').value.trim();
            const lastName = document.getElementById('lastName').value.trim();
            const email = document.getElementById('email').value.trim();
            const phone = document.getElementById('phone').value.trim();

            if (!firstName || !lastName || !email || !phone) {
                showError('Vänligen fyll i alla obligatoriska kontaktfält.');
                return false;
            }

            if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                showError('Vänligen ange en giltig e-postadress.');
                return false;
            }

            if (!/^[\d\s\-\+\(\)]+$/.test(phone)) {
                showError('Vänligen ange ett giltigt telefonnummer.');
                return false;
            }

            const street = document.getElementById('street').value.trim();
            const postalCode = document.getElementById('postalCode').value.trim();
            const city = document.getElementById('city').value.trim();

            if (!street || !postalCode || !city) {
                showError('Vänligen fyll i alla obligatoriska adressfält.');
                return false;
            }

            if (!/^\d{3}\s?\d{2}$/.test(postalCode)) {
                showError('Vänligen ange ett giltigt postnummer (t.ex. 123 45).');
                return false;
            }

            return true;
        }

        function saveCurrentStepData() {
            if (orderState.currentStep === 1) {
                orderState.formData.quantity = orderState.quantity;
                orderState.formData.firstName = document.getElementById('firstName').value.trim();
                orderState.formData.lastName = document.getElementById('lastName').value.trim();
                orderState.formData.fullName = `${orderState.formData.firstName} ${orderState.formData.lastName}`;
                orderState.formData.email = document.getElementById('email').value.trim();
                orderState.formData.phone = document.getElementById('phone').value.trim();
                orderState.formData.street = document.getElementById('street').value.trim();
                orderState.formData.postalCode = document.getElementById('postalCode').value.trim();
                orderState.formData.city = document.getElementById('city').value.trim();
                orderState.formData.country = document.getElementById('country').value;
            }
        }

        function composeOrderEmail(orderData) {
            const subject = `Beställning ${orderData.orderNumber}`;
            const emailBody = `Beställning: ${orderData.orderNumber}
Datum: ${new Date().toLocaleDateString('sv-SE')}

Kund: ${orderData.customer.fullName}
E-post: ${orderData.customer.email}
Telefon: ${orderData.customer.phone}

Adress:
${orderData.delivery.street}
${orderData.delivery.postalCode} ${orderData.delivery.city}
${orderData.delivery.country}

Beställning: ${orderData.items[0].quantity} x Svenska Reformationsbibeln
Totalt: ${orderData.pricing.total} kr (inkl frakt)

Swish-betalning genomförd till: ${orderData.customer.phone}


${orderData.delivery.street}
${orderData.delivery.postalCode} ${orderData.delivery.city}
${orderData.delivery.country}

${orderData.customer.fullName}
${orderData.customer.email}
${orderData.customer.phone}

`;

            return { subject, emailBody };
        }

        function handleEmailService(service) {
            if (!storedEmailData) {
                alert('Ingen beställningsdata hittades.');
                return;
            }

            const subject = encodeURIComponent(storedEmailData.subject);
            const body = encodeURIComponent(storedEmailData.emailBody);
            const recipient = 'post@bibel.se';

            switch (service) {
                case 'gmail':
                    window.open(`https://mail.google.com/mail/?view=cm&fs=1&to=${recipient}&su=${subject}&body=${body}`, '_blank');
                    break;
                case 'outlook':
                    window.open(`https://outlook.live.com/mail/0/deeplink/compose?to=${recipient}&subject=${subject}&body=${body}`, '_blank');
                    break;
                case 'default':
                    window.location.href = `mailto:${recipient}?subject=${subject}&body=${body}`;
                    break;
                case 'copy':
                    copyToClipboard(`Till: ${recipient}\nÄmne: ${storedEmailData.subject}\n\n${storedEmailData.emailBody}`);
                    break;
            }
        }

        function copyToClipboard(text) {
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text).then(() => showCopySuccess()).catch(() => fallbackCopyToClipboard(text));
            } else {
                fallbackCopyToClipboard(text);
            }
        }

        function fallbackCopyToClipboard(text) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.left = '-999999px';
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand('copy');
                showCopySuccess();
            } catch (err) {
                alert('Kunde inte kopiera.');
            }
            document.body.removeChild(textArea);
        }

        function showCopySuccess() {
            const copyBtn = document.querySelector('[data-service="copy"]');
            if (copyBtn) {
                copyBtn.innerHTML = '<i class="fas fa-check" style="color: #28a745;"></i><span>Kopierat!</span>';
                setTimeout(() => {
                    copyBtn.innerHTML = '<i class="fas fa-copy" style="color: #28a745;"></i><span>Kopiera</span>';
                }, 2000);
            }
        }

        function showError(message) {
            if (errorMessage) {
                errorMessage.textContent = message;
                errorMessage.style.display = 'block';
                errorMessage.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        }

        function hideError() {
            if (errorMessage) errorMessage.style.display = 'none';
        }

        document.addEventListener('DOMContentLoaded', initializeApp);

        window.resumeOrder = resumeOrder;
        window.duplicateOrder = duplicateOrder;
        window.deleteOrder = deleteOrder;
    </script>
</body>
</html>